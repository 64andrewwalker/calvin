---
title: Test Variants Rationale
description: Rationale and coverage for test variants and edge cases
---

# Test Variants Rationale

> **Updated**: 2025-12-21

This document explains test variants and the edge cases they cover.

> **Note**: The original `SyncEngine` has been replaced by `DeployUseCase`, but the test coverage principles still apply.

## Variant Test Statistics

| Category | New Tests |
|----------|-----------|
| Input Boundaries | 6 |
| State Variants | 3 |
| Conflict Scenarios | 2 |
| Dry Run Verification | 2 |
| Callback Verification | 1 |
| Lockfile Path Verification | 2 |
| **Total** | **16** |

## Input Boundary Tests

### `engine_sync_with_empty_outputs`
- **Scenario:** Empty output list
- **Coverage:** Boundary condition handling, ensuring empty list doesn't cause errors
- **Expected:** Returns empty result successfully

### `engine_sync_with_empty_content`
- **Scenario:** File content is empty string
- **Coverage:** Empty content handling, zero-byte file writing
- **Expected:** Creates empty file

### `engine_sync_with_unicode_content`
- **Scenario:** Content with Chinese, Japanese, emoji, special characters
- **Coverage:** UTF-8 encoding correctness
- **Expected:** Unicode content fully preserved

### `engine_sync_with_large_content`
- **Scenario:** ~1MB large file
- **Coverage:** Large file handling, memory efficiency
- **Expected:** Correctly writes and hashes

### `engine_sync_with_special_path_characters`
- **Scenario:** Path contains spaces, hyphens, underscores
- **Coverage:** Path encoding, special character escaping
- **Expected:** Correctly creates directories and files

### `engine_sync_with_deeply_nested_path`
- **Scenario:** 8 levels of nested directories
- **Coverage:** Recursive directory creation
- **Expected:** Creates all intermediate directories

## State Variant Tests

### `engine_sync_with_preexisting_lockfile`
- **Scenario:** Existing old version lockfile
- **Coverage:** Lockfile compatibility, incremental updates
- **Expected:** Correctly merges old and new entries

### `engine_sync_multiple_files_same_directory`
- **Scenario:** Multiple files written to same directory
- **Coverage:** Concurrent directory access, batch writing
- **Expected:** All files correctly written

### `engine_sync_multiple_files_different_directories`
- **Scenario:** Multiple files written to different directories
- **Coverage:** Multi-directory creation, path isolation
- **Expected:** Each directory correctly independent

## Conflict Scenario Tests

### `engine_sync_skip_mode_leaves_conflicts_unchanged`
- **Scenario:** Conflict handling when user selects Skip
- **Coverage:** Skip option correctly executes
- **Expected:** User modified content preserved

### `engine_sync_non_interactive_skips_conflicts_silently`
- **Scenario:** Non-interactive mode encounters conflict
- **Coverage:** Default conflict handling strategy
- **Expected:** Silently skips, no error

## Dry Run Verification Tests

### `engine_dry_run_does_not_create_files`
- **Scenario:** Dry run mode file creation
- **Coverage:** Dry run isolation
- **Expected:** Reports writes but doesn't actually create

### `engine_dry_run_does_not_update_lockfile`
- **Scenario:** Dry run mode lockfile update
- **Coverage:** Complete dry run isolation
- **Expected:** Lockfile not created/modified

## Callback Verification Tests

### `engine_sync_callback_receives_correct_events`
- **Scenario:** Verify event callback order
- **Coverage:** Event flow completeness
- **Expected:** Each file receives ItemStart and ItemWritten

## Lockfile Path Verification Tests

### `engine_local_uses_project_lockfile`
- **Scenario:** Local deploy lockfile path
- **Coverage:** Path calculation correctness
- **Expected:** `.promptpack/.calvin.lock`

### `engine_remote_uses_source_lockfile`
- **Scenario:** Remote deploy lockfile path
- **Coverage:** Remote mode local lockfile
- **Expected:** `source/.calvin.lock`

## Overfitting Prevention Measures

1. **Multiple input types:** Unicode, empty content, large files
2. **Boundary values:** Empty lists, deep nesting, special characters
3. **State isolation:** Using TempDir and MockFileSystem for isolation
4. **Behavior verification:** Not just checking results, also verifying side effects (lockfile, events)

## Potential Future Extensions

- Property-based testing (using proptest)
- Concurrent access testing
- Disk full/permission denied scenarios
- Network failure simulation (remote)


## ScopePolicy Variant Tests

### `apply__empty_input_returns_empty`
- **Scenario:** Input is empty list
- **Coverage:** Basic boundary condition
- **Expected:** Returns empty list

### `apply__project_only_on_user_only_input__returns_empty`
- **Scenario:** Input contains only Scope::User assets, policy is ProjectOnly
- **Coverage:** Filter logic correctness
- **Expected:** Returns empty list

## Lockfile Variant Tests

### `key__absolute_path__uses_namespace`
- **Scenario:** Absolute path input
- **Coverage:** Path namespace isolation, preventing absolute path conflicts
- **Expected:** Generates key with namespace prefix

### `key__parent_traversal__is_preserved_in_key`
- **Scenario:** Path contains `..`
- **Coverage:** Key generation stability
- **Expected:** Preserves `..` without resolution (used only as string ID)

### `key__empty_path__handled`
- **Scenario:** Empty path string
- **Coverage:** Boundary value
- **Expected:** Generates key with prefix only

## Pipeline Variant Tests

### `pipeline__compile_incremental_no_changes_after_initial__returns_empty`
- **Scenario:** Incremental compile with no changes
- **Coverage:** Idempotency and cache hits
- **Expected:** Returns complete asset list (idempotent)

### `pipeline__error_on_nonexistent_source`
- **Scenario:** Source directory doesn't exist
- **Coverage:** Error propagation
- **Expected:** Returns error

## Security Variant Tests (Validation)

### `safety__rejects_dotdot_at_start`
- **Scenario:** Path starts with `..`
- **Coverage:** Path traversal defense
- **Expected:** Returns error

### `safety__rejects_absolute_paths_outside_root`
- **Scenario:** Absolute path points outside project
- **Coverage:** Unauthorized access defense
- **Expected:** Returns error

### `safety__allows_tilde_slash`
- **Scenario:** Path starting with `~/`
- **Coverage:** User directory privilege allowance
- **Expected:** Allowed to pass
