# Calvin - Implementation Checklist

> **Status**: Phase 1-5, 7 Complete âœ… | Implementation: In Progress  
> **Started**: 2025-12-17  
> **Estimated Duration**: 4-6 weeks
> **Tests**: 113 passing

---

## Phase 0: Project Bootstrap âœ… COMPLETE

- [x] Initialize Rust project (`cargo init --name calvin`)
- [x] Set up workspace directory structure
- [x] Add dependencies to `Cargo.toml`:
  - [x] `clap` - CLI framework (minimal features)
  - [x] `serde`, `serde_yaml`, `serde_json` - Parsing
  - [x] `tempfile` - Atomic writes (TD-14)
  - [x] `sha2` - Lockfile hashing (TD-15)
  - [x] `notify` - File watcher (minimal features)
  - [x] `anyhow`, `thiserror` - Error handling
  - [x] `which` - Tool detection for remote sync
- [x] Configure release profile (TD-17: lto, strip, opt-level=z)
- [ ] Configure GitHub Actions CI
- [ ] Set up cross-compilation targets

---

## Phase 1: Source Parser âœ… COMPLETE

- [x] Define core data structures:
  - [x] `PromptAsset` - Parsed source file
  - [x] `Frontmatter` - YAML metadata (description, targets, scope, apply)
  - [ ] `Config` - Project/user configuration
- [x] Implement frontmatter extraction (`---` delimiter parsing)
- [x] Implement YAML parsing with serde
- [x] Add validation for required field (`description`)
- [ ] **Format versioning** (from API versioning plan):
  - [ ] Read `[format] version` from `config.toml`
  - [ ] Validate against supported versions
  - [ ] Error if version too new, warn if deprecated
- [x] Parse `.promptpack/` directory structure recursively
- [x] Write unit tests for parser (25+ tests)

---

## âš ï¸ Phase 1.5: Pitfall Mitigations (P0 - Before v0.1) âœ… COMPLETE

> See `docs/pitfall-mitigations.md` for details

- [x] **TD-4 Fix**: Context-aware escaping (`OutputFormat` enum)
  - [x] `escape_json()` for JSON outputs
  - [x] `escape_toml()` for TOML outputs
  - [x] Use serde for structured data, never string interpolation
- [x] **TD-14**: Atomic writes via tempfile + rename
  - [x] Windows retry logic (3x backoff on lock failure)
- [x] **TD-15**: Lockfile system (`.promptpack/.calvin.lock`)
  - [x] Record file hashes after generation
  - [x] Detect user modifications before overwrite
  - [x] SKIP + WARNING if hash mismatch
- [x] **TD-16**: Hardcoded minimum deny list (even in yolo)
  - [x] `.env`, `*.pem`, `*.key`, `id_rsa`, `.git/`

---

## Phase 2: Core Adapters (Project Scope) âœ… COMPLETE

### Claude Code Adapter âœ…
- [x] Generate `.claude/commands/<id>.md`
- [x] Generate `.claude/settings.json` with deny rules
- [ ] Handle `$ARGUMENTS` for inputs (with JSON escaping!)
- [x] Add "Generated by" header

### Cursor Adapter âœ…
- [x] Generate `.cursor/rules/<id>/RULE.md`
- [x] Map frontmatter: `description` â†’ RULE.md frontmatter
- [x] Map `apply` glob â†’ `globs` field
- [x] Generate `.cursor/commands/<id>.md`

### VS Code Adapter âœ…
- [x] Generate `.github/copilot-instructions.md` (merged mode)
- [x] Generate `.github/instructions/<id>.md` (split mode)
- [x] Map `apply` glob â†’ `applyTo` frontmatter
- [x] Generate `AGENTS.md` summary index

### Antigravity Adapter âœ…
- [x] Generate `.agent/rules/<id>.md`
- [x] Generate `.agent/workflows/<id>.md`

### Codex Adapter âœ…
- [x] Generate `.codex/prompts/<id>.md`
- [x] Generate usage header with $ARGUMENTS documentation

### Adapter Infrastructure
- [ ] **TD-18**: Versioned adapter trait
  - [ ] `output_format_version()`
  - [ ] `min_ide_version()`
  - [ ] `max_tested_version()`
  - [ ] `detect_version()` for installed IDE

---

## Phase 3: Sync Engine âœ… COMPLETE

- [x] Implement `sync` command
  - [x] Parse â†’ Compile â†’ Write cycle
  - [x] Use atomic writes (TD-14)
  - [x] Update lockfile after write (TD-15)
- [ ] Implement `diff` command (preview changes)
- [x] Implement header marker system ("Generated by Calvin")
- [x] Implement `--force` override
- [ ] Implement `--merge` (optional, for JSON/YAML structural merge)
- [x] Implement `--dry-run`
- [x] Ensure idempotency

---

## Phase 4: File Watcher

- [ ] Implement `watch` command
- [ ] Add debouncing (100ms)
- [ ] Incremental compilation (only changed files)
- [ ] Respect lockfile (warn on user changes)
- [ ] Graceful Ctrl+C shutdown
- [ ] NDJSON output mode for streaming

---

## Phase 5: Doctor & Validation âœ… MOSTLY COMPLETE

- [x] Implement `doctor` command
- [x] Security mode validation:
  - [x] `strict`: ERROR on missing deny lists
  - [x] `balanced`: WARNING on missing protections
  - [x] `yolo`: INFO only
- [x] Platform-specific validation:
  - [x] Claude Code: permissions.deny exists
  - [x] Antigravity: not in Turbo mode (warning)
  - [ ] Cursor: MCP servers in allowlist
  - [ ] VS Code: chat.useAgentsMdFile setting
- [x] Checklist output format (âœ“ / âš  / âœ—)
- [ ] **TD-18**: IDE version detection
  - [ ] Detect installed IDE versions
  - [ ] Warn if IDE version > max_tested_version
- [ ] Config validation (`--config` flag)

---

## Phase 5.5: Audit Command (P2)

- [ ] Implement `calvin audit` command
- [ ] CI mode (`--ci`) with exit code 1 on violations
- [ ] Check deny list completeness
- [ ] Check MCP allowlist
- [ ] Suitable for PR blocking in CI/CD

---

## Phase 6: User Scope & Remote

- [ ] Implement `install --user`
  - [ ] Write to `~/.claude/commands/`
  - [ ] Write to `~/.gemini/antigravity/`
  - [ ] Write to `~/.codex/prompts/`
- [ ] Implement Codex adapter
  - [ ] `$ARGUMENTS` / `$1`-`$9` / `$KEY` placeholders
  - [ ] Usage docs header generation
- [ ] Implement `sync --remote user@host:/path`
- [ ] **TD-6 Fix**: Windows fallback
  - [ ] Try rsync first
  - [ ] Fall back to scp (Windows 10+ native)
  - [ ] Clear error if neither available

---

## Phase 7: Configuration âœ… PARTIAL

- [x] Configuration file loading (TOML)
  - [x] User config: `~/.config/calvin/config.toml`
  - [x] Project config: `.promptpack/config.toml`
- [ ] Environment variable support (`CALVIN_*` prefix)
- [x] Security mode config (`[security] mode = "yolo"`)
- [x] Target enable/disable config
- [x] `--json` for all commands
- [ ] Shell completions (bash, zsh, fish, PowerShell)

---

## Phase 7.5: Migration Commands (from API versioning plan)

- [ ] Implement `calvin migrate` command
  - [ ] `--format 1.0` - Migrate source format
  - [ ] `--adapter cursor` - Migrate specific adapter output
  - [ ] `--dry-run` - Preview migration
- [ ] Implement `calvin --version` with full info
  - [ ] Show source format version
  - [ ] Show each adapter version + tested IDE range

---

## Phase 8: Testing & Docs

- [ ] Unit tests (>80% coverage)
- [ ] Snapshot tests with `insta` crate
- [ ] Golden test suite (reference .promptpack â†’ expected output)
- [ ] **Escaping tests**: Ensure JSON with quotes doesn't corrupt
- [ ] **Version compatibility tests**: Format version parsing
- [ ] README quick start guide
- [ ] Command reference documentation
- [ ] Example `.promptpack/` âœ… (36 workflows included)

---

## Phase 9: Distribution

- [ ] GitHub Actions release workflow
- [ ] Cross-compilation (5 targets):
  - [ ] `x86_64-apple-darwin` (Intel Mac)
  - [ ] `aarch64-apple-darwin` (Apple Silicon)
  - [ ] `x86_64-pc-windows-msvc` (Windows)
  - [ ] `x86_64-unknown-linux-gnu` (Linux x64)
  - [ ] `aarch64-unknown-linux-gnu` (Linux ARM)
- [ ] Binary size verification (<10MB target)
- [ ] Homebrew formula
- [ ] Scoop manifest (Windows)
- [ ] cargo-binstall support

---

## Documentation âœ… COMPLETE

| Document | Status | Description |
|----------|--------|-------------|
| `docs/architecture.md` | âœ… | System design, components, data flow |
| `docs/implementation-plan.md` | âœ… | 9-phase roadmap with estimates |
| `docs/tech-decisions.md` | âœ… | TD-1 through TD-18 |
| `docs/pitfall-mitigations.md` | âœ… | 7 critical architectural fixes |
| `docs/api-versioning-policy.md` | âœ… | Source format & adapter versioning |
| `docs/api-changelog.md` | âœ… | Version history for formats |
| `docs/configuration.md` | âœ… | Config file, env vars, CLI args |
| `docs/target-platforms.md` | âœ… | IDE versions & output formats (Dec 2025) |

---

## Summary

| Phase | Status | Key Items |
|-------|--------|-----------|
| 0: Bootstrap | âœ… Complete | Rust project, deps, release profile |
| 1: Parser | âœ… Complete | Frontmatter, YAML, validation (25+ tests) |
| 1.5: Pitfalls | âœ… Complete | Escaping, atomic writes, lockfile |
| 2: Adapters | âœ… Complete | 5 platform adapters (52+ tests) |
| 3: Sync | âœ… Complete | sync, dry-run, force, lockfile |
| 4: Watch | ðŸ”² Not Started | File watcher, debounce |
| 5: Doctor | âœ… Complete | Validation, security checks |
| 5.5: Audit | ðŸ”² Not Started | CI security check |
| 6: Remote | ðŸ”² Not Started | User scope, SSH sync |
| 7: Config | âœ… Partial | TOML config, security mode |
| 7.5: Migrate | ðŸ”² Not Started | Format/adapter migration |
| 8: Testing | ðŸ”² In Progress | 113 tests passing |
| 9: Distribution | ðŸ”² Not Started | CI, binaries, package managers |

**Total**: 113 tests passing, 5 phases complete, working CLI


