# Calvin æ¶æ„å®¡æŸ¥

> **Created**: 2025-12-19  
> **Status**: Draft

---

## é¡¹ç›®æ¦‚è§ˆ

**Calvin** æ˜¯ä¸€ä¸ª AI prompt ç®¡ç†å·¥å…·ï¼Œå°† `.promptpack/` ä¸­çš„æºæ–‡ä»¶ç¼–è¯‘å¹¶éƒ¨ç½²åˆ°å¤šä¸ª AI å·¥å…·çš„é…ç½®ç›®å½•ã€‚

```
.promptpack/           â† æºæ–‡ä»¶
    commands/
    policies/
    
    â†“ (compile)
    
OutputFile[]           â† ä¸­é—´è¡¨ç¤º

    â†“ (deploy)
    
.claude/               â† ç›®æ ‡ A
.cursor/               â† ç›®æ ‡ B
~/.claude/             â† ç›®æ ‡ C (home)
```

---

## å½“å‰æ¨¡å—ç»“æ„

```
src/
â”œâ”€â”€ adapters/          # ç›®æ ‡æ ¼å¼è½¬æ¢å™¨ (Claude, Cursor, VS Code...)
â”œâ”€â”€ commands/          # CLI å‘½ä»¤
â”‚   â”œâ”€â”€ deploy/        # éƒ¨ç½²å‘½ä»¤
â”‚   â”œâ”€â”€ check.rs       # å®‰å…¨æ£€æŸ¥
â”‚   â”œâ”€â”€ interactive.rs # äº¤äº’å¼ CLI
â”‚   â””â”€â”€ watch.rs       # æ–‡ä»¶ç›‘æ§
â”œâ”€â”€ sync/              # åŒæ­¥å¼•æ“
â”‚   â”œâ”€â”€ engine.rs      # ç»Ÿä¸€åŒæ­¥ API (1601 è¡Œ!)
â”‚   â”œâ”€â”€ plan.rs        # è®¡åˆ’é˜¶æ®µ
â”‚   â”œâ”€â”€ execute.rs     # æ‰§è¡Œé˜¶æ®µ
â”‚   â”œâ”€â”€ lockfile.rs    # é”æ–‡ä»¶ç®¡ç†
â”‚   â”œâ”€â”€ orphan.rs      # å­¤å„¿æ£€æµ‹
â”‚   â””â”€â”€ pipeline.rs    # èµ„äº§ç¼–è¯‘ç®¡é“
â”œâ”€â”€ ui/                # ç”¨æˆ·ç•Œé¢
â”‚   â”œâ”€â”€ views/         # è§†å›¾æ¸²æŸ“å™¨
â”‚   â”œâ”€â”€ blocks/        # UI å—
â”‚   â”œâ”€â”€ primitives/    # åŸºç¡€å…ƒç´ 
â”‚   â””â”€â”€ widgets/       # å¤æ‚ç»„ä»¶
â”œâ”€â”€ config.rs          # é…ç½®ç®¡ç† (794 è¡Œ)
â”œâ”€â”€ security.rs        # å®‰å…¨ç­–ç•¥ (1155 è¡Œ)
â”œâ”€â”€ parser.rs          # èµ„äº§è§£æ
â”œâ”€â”€ models.rs          # æ•°æ®æ¨¡å‹
â””â”€â”€ fs.rs              # æ–‡ä»¶ç³»ç»ŸæŠ½è±¡
```

---

## è¯†åˆ«åˆ°çš„é—®é¢˜

### ğŸ”´ é—®é¢˜ 1: ä¸Šå¸å¯¹è±¡ - `SyncEngine` (1601 è¡Œ)

**ä½ç½®**: `src/sync/engine.rs`

**èŒè´£å¤ªå¤š**:
1. æœ¬åœ°åŒæ­¥
2. Home ç›®å½•åŒæ­¥
3. è¿œç¨‹ SSH åŒæ­¥
4. Watch æ¨¡å¼åŒæ­¥
5. Lockfile æ›´æ–°
6. å†²çªè§£å†³
7. Rsync ä¼˜åŒ–

**ä»£ç è¯æ®**:
```rust
// ä¸€ä¸ªç±»åšäº†æ‰€æœ‰äº‹æƒ…
impl SyncEngine {
    pub fn local(...)         // æœ¬åœ°
    pub fn home(...)          // Home
    pub fn remote(...)        // è¿œç¨‹
    pub fn sync(...)          // åŒæ­¥
    pub fn sync_with_callback(...) // å¸¦å›è°ƒåŒæ­¥
    fn plan_sync(...)         // è®¡åˆ’
    fn resolve_conflicts(...) // è§£å†³å†²çª
    fn execute_sync(...)      // æ‰§è¡Œ
    fn update_lockfile(...)   // æ›´æ–°é”æ–‡ä»¶
}
```

**å»ºè®®æ‹†åˆ†**:
```
sync/
â”œâ”€â”€ engine.rs        â†’ åªä¿ç•™å…¬å…±æ¥å£å’Œåè°ƒé€»è¾‘
â”œâ”€â”€ local_sync.rs    â†’ LocalSyncStrategy
â”œâ”€â”€ home_sync.rs     â†’ HomeSyncStrategy  
â”œâ”€â”€ remote_sync.rs   â†’ RemoteSyncStrategy
â””â”€â”€ traits.rs        â†’ SyncStrategy trait
```

---

### ğŸ”´ é—®é¢˜ 2: ä¸Šå¸å¯¹è±¡ - `security.rs` (1155 è¡Œ)

**ä½ç½®**: `src/security.rs`

**èŒè´£å¤ªå¤š**:
1. è§„åˆ™å®šä¹‰
2. è§„åˆ™éªŒè¯
3. åŸºçº¿ç®¡ç†
4. è¿è§„æŠ¥å‘Š
5. å»ºè®®ç”Ÿæˆ

**å»ºè®®æ‹†åˆ†**:
```
security/
â”œâ”€â”€ mod.rs           â†’ å…¬å…± API
â”œâ”€â”€ rules.rs         â†’ è§„åˆ™å®šä¹‰
â”œâ”€â”€ validator.rs     â†’ éªŒè¯é€»è¾‘
â”œâ”€â”€ baseline.rs      â†’ åŸºçº¿ç®¡ç†
â””â”€â”€ reporter.rs      â†’ æŠ¥å‘Šç”Ÿæˆ
```

---

### ğŸ”´ é—®é¢˜ 3: ä¸Šå¸å¯¹è±¡ - `config.rs` (794 è¡Œ)

**ä½ç½®**: `src/config.rs`

**èŒè´£å¤ªå¤š**:
1. é…ç½®ç»“æ„å®šä¹‰
2. åŠ è½½/ä¿å­˜é€»è¾‘
3. é»˜è®¤å€¼
4. è¿ç§»é€»è¾‘
5. éªŒè¯é€»è¾‘

**å»ºè®®æ‹†åˆ†**:
```
config/
â”œâ”€â”€ mod.rs           â†’ å…¬å…± API
â”œâ”€â”€ types.rs         â†’ é…ç½®ç±»å‹å®šä¹‰
â”œâ”€â”€ loader.rs        â†’ åŠ è½½é€»è¾‘
â”œâ”€â”€ saver.rs         â†’ ä¿å­˜é€»è¾‘
â””â”€â”€ migration.rs     â†’ ç‰ˆæœ¬è¿ç§»
```

---

### ğŸŸ¡ é—®é¢˜ 4: è€¦åˆ - `commands/deploy/runner.rs` vs `sync/engine.rs`

**é—®é¢˜**: `DeployRunner` å’Œ `SyncEngine` èŒè´£é‡å 

**ä»£ç è¯æ®**:
```rust
// runner.rs ä¸­æœ‰ sync é€»è¾‘
impl DeployRunner {
    fn sync_local_with_engine(...) // å§”æ‰˜ç»™ SyncEngine
    fn sync_remote(...)            // è‡ªå·±å®ç°è¿œç¨‹åŒæ­¥!
    fn update_lockfile(...)        // é‡å¤ SyncEngine çš„é€»è¾‘
}
```

**å»ºè®®**:
- `DeployRunner` åº”è¯¥åªè´Ÿè´£"å‘½ä»¤ç¼–æ’"
- æ‰€æœ‰åŒæ­¥é€»è¾‘åº”è¯¥åœ¨ `SyncEngine` ä¸­
- `runner.rs` åº”è¯¥å˜æˆä¸€ä¸ªè–„å±‚

---

### ğŸŸ¡ é—®é¢˜ 5: å¾ªç¯ä¾èµ–é£é™©

**é—®é¢˜**: `sync` æ¨¡å—å’Œ `commands/deploy` æ¨¡å—ç›¸äº’äº†è§£å¤ªå¤š

```
commands/deploy/runner.rs
    â†“ uses
sync/engine.rs
    â†“ uses
adapters/OutputFile
    â†‘ used by
commands/deploy/runner.rs (AssetPipeline)
```

**å»ºè®®**:
- å®šä¹‰æ¸…æ™°çš„æ¨¡å—è¾¹ç•Œ
- ä½¿ç”¨ trait è§£è€¦

---

### ğŸŸ¡ é—®é¢˜ 6: UI æ¸²æŸ“æ•£è½å„å¤„

**é—®é¢˜**: å¾ˆå¤šå‘½ä»¤æ–‡ä»¶ä¸­ç›´æ¥è°ƒç”¨ `eprintln!` å’Œ `println!`

**ä»£ç è¯æ®**:
```rust
// cmd.rs ä¸­ç›´æ¥æ¸²æŸ“
eprintln!("{}", render_orphan_list(...));
eprintln!("\n{} {} orphan file(s) detected...", Icon::Warning...);
```

**å»ºè®®**:
- æ‰€æœ‰ UI è¾“å‡ºåº”è¯¥é€šè¿‡ç»Ÿä¸€çš„ `Renderer` trait
- å‘½ä»¤å±‚åªå…³å¿ƒä¸šåŠ¡é€»è¾‘

---

## å»ºè®®çš„ç›®æ ‡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLI (main.rs)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Commands (thin layer)                     â”‚
â”‚  - deploy, check, watch, interactive                        â”‚
â”‚  - åªè´Ÿè´£å‚æ•°è§£æå’Œç¼–æ’ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Domain Services                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Pipeline â”‚  â”‚  Sync    â”‚  â”‚ Security â”‚  â”‚ Watcher  â”‚    â”‚
â”‚  â”‚ Service  â”‚  â”‚ Service  â”‚  â”‚ Service  â”‚  â”‚ Service  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Infrastructure                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ FileSystemâ”‚  â”‚ Config   â”‚  â”‚ Lockfile â”‚  â”‚ Remote   â”‚    â”‚
â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚  â”‚ (SSH)    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Adapters                             â”‚
â”‚  Claude Code | Cursor | VS Code | Antigravity | Codex       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é‡æ„ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | å½±å“ | å·¥ä½œé‡ |
|--------|------|------|--------|
| ğŸ”´ P0 | æ‹†åˆ† `SyncEngine` | é™ä½å¤æ‚åº¦ï¼Œæ›´æ˜“æµ‹è¯• | å¤§ |
| ğŸ”´ P1 | æ‹†åˆ† `security.rs` | æ›´æ¸…æ™°çš„å®‰å…¨æ¨¡å— | ä¸­ |
| ğŸŸ¡ P2 | åˆå¹¶ `runner.rs` å’Œ `engine.rs` | æ¶ˆé™¤é‡å¤ | ä¸­ |
| ğŸŸ¡ P3 | æ‹†åˆ† `config.rs` | æ›´æ˜“ç»´æŠ¤ | å° |
| ğŸŸ¢ P4 | UI æ¸²æŸ“ç»Ÿä¸€ | æ›´å¥½çš„ UX ä¸€è‡´æ€§ | å° |

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **åˆ›å»º RFC**: ä¸ºæ¯ä¸ªé‡æ„ä»»åŠ¡åˆ›å»ºè®¾è®¡æ–‡æ¡£
2. **TDD è¦†ç›–**: åœ¨é‡æ„å‰å¢åŠ æµ‹è¯•è¦†ç›–ç‡
3. **æ¸è¿›å¼é‡æ„**: ä¸€æ¬¡åªæ”¹ä¸€ä¸ªæ¨¡å—ï¼Œä¿æŒå‘åå…¼å®¹

---

## é™„å½•ï¼šå¤§æ–‡ä»¶åˆ—è¡¨

| æ–‡ä»¶ | è¡Œæ•° | èŒè´£ |
|------|------|------|
| `sync/engine.rs` | 1601 | åŒæ­¥å¼•æ“ |
| `security.rs` | 1155 | å®‰å…¨æ£€æŸ¥ |
| `config.rs` | 794 | é…ç½®ç®¡ç† |
| `commands/interactive.rs` | 639 | äº¤äº’å¼ CLI |
| `watcher.rs` | 635 | æ–‡ä»¶ç›‘æ§ |
| `sync/plan.rs` | 581 | åŒæ­¥è®¡åˆ’ |
| `commands/deploy/cmd.rs` | 545 | éƒ¨ç½²å‘½ä»¤ |

