# Clean Command - Product Requirements Document

> **Status**: Draft  
> **Author**: Product Team  
> **Created**: 2025-12-23  

## Executive Summary

ç”¨æˆ·éœ€è¦ä¸€ç§å®‰å…¨ã€å¯æ§çš„æ–¹å¼æ¥æ¸…é™¤ Calvin å·²éƒ¨ç½²çš„ prompt æ–‡ä»¶ã€‚å½“å‰ Calvin åªæä¾›äº† `--cleanup` é€‰é¡¹ç”¨äºåˆ é™¤"å­¤å„¿æ–‡ä»¶"ï¼Œä½†ç¼ºå°‘å®Œæ•´çš„æ¸…ç†èƒ½åŠ›ã€‚

## Problem Statement

### å½“å‰ç—›ç‚¹

1. **æ— æ³•å®Œå…¨æ¸…é™¤å·²éƒ¨ç½²å†…å®¹**ï¼šç”¨æˆ·æƒ³è¦ç§»é™¤æŸä¸ªé¡¹ç›®éƒ¨ç½²åˆ° home ç›®å½•çš„æ‰€æœ‰ promptsï¼Œå½“å‰æ²¡æœ‰ç›´æ¥çš„æ–¹æ³•ã€‚

2. **ç¦ç”¨ target åæ®‹ç•™æ–‡ä»¶**ï¼šç”¨æˆ·åœ¨ `config.toml` ä¸­å°†æŸä¸ª target ä» `enabled` åˆ—è¡¨ç§»é™¤åï¼Œä¹‹å‰å·²éƒ¨ç½²åˆ°è¯¥ target çš„æ–‡ä»¶ä¸ä¼šè¢«è‡ªåŠ¨æ¸…ç†ã€‚

3. **è·¨é¡¹ç›®å†²çª**ï¼šå¤šä¸ªé¡¹ç›®å¯èƒ½å‘åŒä¸€ä¸ª home ç›®å½•éƒ¨ç½²å†…å®¹ï¼Œç”¨æˆ·éœ€è¦ç²¾ç¡®æ§åˆ¶æ¸…ç†èŒƒå›´ã€‚

4. **æ‰‹åŠ¨åˆ é™¤é£é™©**ï¼šç”¨æˆ·ä¸å¾—ä¸æ‰‹åŠ¨æŸ¥æ‰¾å¹¶åˆ é™¤æ–‡ä»¶ï¼Œå¯èƒ½è¯¯åˆ é Calvin ç®¡ç†çš„é…ç½®ã€‚

## User Stories

### US-1: å®Œå…¨æ¸…é™¤ Home ç›®å½•éƒ¨ç½²

**As a** å¼€å‘è€…  
**I want to** æ¸…é™¤ Calvin éƒ¨ç½²åˆ°æˆ‘ home ç›®å½•çš„æ‰€æœ‰ prompt æ–‡ä»¶  
**So that** æˆ‘å¯ä»¥æ¢å¤åˆ°å¹²å‡€çš„çŠ¶æ€ï¼Œæˆ–å‡†å¤‡ä½¿ç”¨æ–°çš„ promptpack

**Acceptance Criteria:**

- èƒ½ä¸€é”®æ¸…é™¤æ‰€æœ‰ `home:` scope çš„å·²éƒ¨ç½²æ–‡ä»¶
- æ˜¾ç¤ºå°†è¦åˆ é™¤çš„æ–‡ä»¶åˆ—è¡¨ä¾›ç¡®è®¤
- æ›´æ–°é”æ–‡ä»¶ï¼Œç§»é™¤å·²åˆ é™¤çš„æ¡ç›®
- ä¸å½±å“é¡¹ç›®çº§ (`project:`) çš„éƒ¨ç½²

### US-2: æŒ‰ Target æ¸…é™¤

**As a** å¼€å‘è€…  
**I want to** åªæ¸…é™¤æŸä¸ªç‰¹å®šå¹³å°ï¼ˆå¦‚ Cursorï¼‰çš„å·²éƒ¨ç½²æ–‡ä»¶  
**So that** æˆ‘å¯ä»¥åœæ­¢ä½¿ç”¨æŸä¸ª AI å·¥å…·è€Œä¸å½±å“å…¶ä»–å·¥å…·

**Acceptance Criteria:**

- æ”¯æŒ `--target cursor` å‚æ•°æŒ‡å®šè¦æ¸…ç†çš„å¹³å°
- å¯ä»¥ç»„åˆå¤šä¸ª targetsï¼š`--target cursor --target codex`
- åªåˆ é™¤æŒ‡å®š target çš„æ–‡ä»¶ï¼Œä¿ç•™å…¶ä»– target çš„éƒ¨ç½²

### US-3: æŒ‰ Scope æ¸…é™¤

**As a** å¼€å‘è€…  
**I want to** åªæ¸…é™¤ç”¨æˆ·çº§æˆ–é¡¹ç›®çº§çš„éƒ¨ç½²  
**So that** æˆ‘å¯ä»¥ç²¾ç¡®æ§åˆ¶æ¸…ç†èŒƒå›´

**Acceptance Criteria:**

- æ”¯æŒ `--home` åªæ¸…é™¤ home ç›®å½•éƒ¨ç½²
- æ”¯æŒ `--project` åªæ¸…é™¤é¡¹ç›®ç›®å½•éƒ¨ç½²
- ä¸¤è€…éƒ½ä¸æŒ‡å®šæ—¶ï¼Œæ¸…é™¤æ‰€æœ‰ scope

### US-4: è‡ªåŠ¨æ¸…ç†ç¦ç”¨çš„ Targets

**As a** å¼€å‘è€…  
**I want to** å½“æˆ‘ä¿®æ”¹ `config.toml` ç¦ç”¨æŸä¸ª target åï¼Œä¸‹æ¬¡ deploy æ—¶è‡ªåŠ¨æ¸…ç†è¯¥ target çš„å·²éƒ¨ç½²æ–‡ä»¶  
**So that** é…ç½®å˜æ›´èƒ½è‡ªåŠ¨åæ˜ åˆ°éƒ¨ç½²ç»“æœ

**Acceptance Criteria:**

- `calvin deploy` æ£€æµ‹é”æ–‡ä»¶ä¸­å­˜åœ¨ä½†å½“å‰ `enabled` åˆ—è¡¨ä¸­æ²¡æœ‰çš„ targets
- æç¤ºç”¨æˆ·è¿™äº› target å·²è¢«ç¦ç”¨ï¼Œè¯¢é—®æ˜¯å¦æ¸…ç†
- ç”¨æˆ·ç¡®è®¤ååˆ é™¤è¿™äº› target çš„å·²éƒ¨ç½²æ–‡ä»¶
- æ”¯æŒ `--yes` è‡ªåŠ¨ç¡®è®¤

### US-5: äº¤äº’å¼æ¸…ç†

**As a** å¼€å‘è€…  
**I want to** é€šè¿‡äº¤äº’å¼èœå•é€‰æ‹©è¦æ¸…ç†çš„å†…å®¹  
**So that** æˆ‘ä¸éœ€è¦è®°ä½å‘½ä»¤å‚æ•°ï¼Œå¯ä»¥å®‰å…¨åœ°æ“ä½œ

**Acceptance Criteria:**

- ç›´æ¥è¿è¡Œ `calvin clean` è¿›å…¥äº¤äº’æ¨¡å¼
- æ˜¾ç¤ºå½“å‰å·²éƒ¨ç½²çš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆæŒ‰ scope å’Œ target åˆ†ç»„ï¼‰
- æä¾›å¤šé€‰èœå•è®©ç”¨æˆ·å‹¾é€‰è¦æ¸…ç†çš„é¡¹ç›®
- ç¡®è®¤å‰æ˜¾ç¤ºå®Œæ•´çš„æ–‡ä»¶åˆ—è¡¨

### US-6: Dry Run é¢„è§ˆ

**As a** å¼€å‘è€…  
**I want to** é¢„è§ˆå°†è¦åˆ é™¤çš„æ–‡ä»¶è€Œä¸å®é™…æ‰§è¡Œ  
**So that** æˆ‘å¯ä»¥åœ¨æ‰§è¡Œå‰ç¡®è®¤æ“ä½œæ˜¯å®‰å…¨çš„

**Acceptance Criteria:**

- æ”¯æŒ `--dry-run` å‚æ•°
- æ˜¾ç¤ºæ‰€æœ‰å°†è¢«åˆ é™¤çš„æ–‡ä»¶è·¯å¾„
- æ˜¾ç¤ºæ±‡æ€»ç»Ÿè®¡ï¼ˆæ–‡ä»¶æ•°ã€æŒ‰ target åˆ†ç»„ï¼‰
- ä¸ä¿®æ”¹ä»»ä½•æ–‡ä»¶æˆ–é”æ–‡ä»¶

## Command Design

### å‘½åè€ƒé‡

| å€™é€‰åç§° | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|------|------|
| `uninstall` | è¯­ä¹‰æ˜ç¡® | å¯èƒ½è¯¯è§£ä¸ºå¸è½½ Calvin CLI æœ¬èº« |
| `clean` | ç®€æ´ï¼Œå¸¸è§äº build tools | å¯èƒ½ä¸"æ¸…ç†ç¼“å­˜"æ··æ·† |
| `remove` | ç›´è§‚ | ä¸ `rm` ç±»ä¼¼ï¼Œå¬èµ·æ¥å±é™© |
| `purge` | å¼ºè°ƒå½»åº•åˆ é™¤ | è¿‡äºæ¿€è¿›ï¼Œä¸å¤Ÿå‹å¥½ |
| `withdraw` | "æ’¤å›éƒ¨ç½²"è¯­ä¹‰å‡†ç¡® | ä¸å¸¸è§ï¼Œä¸å¤Ÿç›´è§‚ |
| `retract` | "æ”¶å›"è¯­ä¹‰è´´åˆ‡ | åŒä¸Š |

**å»ºè®®ï¼š`clean`**  

- ä¸ `cargo clean`ã€`npm clean` ç­‰å·¥å…·ä¸€è‡´
- é…åˆå­å‘½ä»¤æˆ–å‚æ•°å¯ä»¥æ¸…æ™°è¡¨è¾¾æ„å›¾
- ä¸ä¼šä¸"å¸è½½ Calvin"æ··æ·†

### å‘½ä»¤è¯­æ³•

```bash
# äº¤äº’å¼æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
calvin clean

# æ¸…é™¤æ‰€æœ‰ home ç›®å½•éƒ¨ç½²
calvin clean --home

# æ¸…é™¤æŒ‡å®š target
calvin clean --target cursor

# æ¸…é™¤æ‰€æœ‰éƒ¨ç½²ï¼ˆhome + projectï¼‰
calvin clean --all

# ç»„åˆä½¿ç”¨
calvin clean --home --target cursor --target codex

# é¢„è§ˆæ¨¡å¼
calvin clean --home --dry-run

# éäº¤äº’å¼ç¡®è®¤
calvin clean --home --yes
```

### è¾“å‡ºç¤ºä¾‹

```text
ğŸ“‹ Calvin Clean

Current deployments:
  Home (~/):
    â”œâ”€ claude-code: 27 files
    â”œâ”€ cursor: 27 files
    â”œâ”€ antigravity: 27 files
    â””â”€ codex: 27 files
  
  Project (/path/to/project):
    â”œâ”€ claude-code: 27 files
    â””â”€ cursor: 27 files

? What would you like to clean?
  [ ] All home deployments (108 files)
  [ ] claude-code home (27 files)
  [ ] cursor home (27 files)  
  [ ] antigravity home (27 files)
  [ ] codex home (27 files)
  [ ] All project deployments (54 files)
  
> Confirm selection (Space to toggle, Enter to proceed)
```

## Integration with Deploy

### è‡ªåŠ¨æ£€æµ‹ç¦ç”¨çš„ Targets

å½“ `calvin deploy` æ‰§è¡Œæ—¶ï¼š

1. è¯»å–é”æ–‡ä»¶ä¸­çš„å·²éƒ¨ç½² targetsï¼ˆå»é‡ï¼‰
2. å¯¹æ¯” `config.toml` ä¸­çš„ `targets.enabled`
3. å¦‚æœå­˜åœ¨å·²éƒ¨ç½²ä½†æœªå¯ç”¨çš„ targetï¼š

```text
âš ï¸  Detected disabled targets with existing deployments:
    - cursor (27 files in home, 27 files in project)
    - codex (27 files in home)

These targets are no longer in your enabled list.
? Clean up files for disabled targets? [Y/n]
```

1. ç”¨æˆ·ç¡®è®¤åæ‰§è¡Œæ¸…ç†
2. ä½¿ç”¨ `--yes` å¯è·³è¿‡ç¡®è®¤

## Technical Considerations

### é”æ–‡ä»¶ä¾èµ–

- `clean` å‘½ä»¤ä¾èµ–é”æ–‡ä»¶ (`.calvin.lock`) æ¥è¯†åˆ« Calvin ç®¡ç†çš„æ–‡ä»¶
- é”æ–‡ä»¶ä¸­çš„ `home:` å‰ç¼€ç”¨äºåŒºåˆ† scope
- é”æ–‡ä»¶è®°å½•äº†æ–‡ä»¶çš„ target æ¥æº

### å®‰å…¨æœºåˆ¶

1. **ç­¾åéªŒè¯**ï¼šåªåˆ é™¤åŒ…å« Calvin ç­¾åçš„æ–‡ä»¶ï¼ˆé˜²æ­¢è¯¯åˆ ç”¨æˆ·æ‰‹åŠ¨åˆ›å»ºçš„æ–‡ä»¶ï¼‰
2. **é”æ–‡ä»¶åŒ¹é…**ï¼šåªåˆ é™¤é”æ–‡ä»¶ä¸­è®°å½•çš„æ–‡ä»¶
3. **ç¡®è®¤æç¤º**ï¼šé»˜è®¤éœ€è¦ç”¨æˆ·ç¡®è®¤
4. **Dry Run**ï¼šæ”¯æŒé¢„è§ˆæ¨¡å¼

### è·¨é¡¹ç›®åœºæ™¯

- æ¯ä¸ªé¡¹ç›®æœ‰ç‹¬ç«‹çš„é”æ–‡ä»¶
- `clean --home` åªæ¸…ç†å½“å‰é¡¹ç›®åœ¨ home ç›®å½•çš„éƒ¨ç½²
- ä¸å½±å“å…¶ä»–é¡¹ç›®çš„ home éƒ¨ç½²

## Open Questions

1. **æ˜¯å¦éœ€è¦ `--force` è·³è¿‡ç­¾åéªŒè¯ï¼Ÿ**
   - åœºæ™¯ï¼šç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹äº† Calvin éƒ¨ç½²çš„æ–‡ä»¶ï¼Œæƒ³å¼ºåˆ¶æ¸…ç†

2. **æ˜¯å¦æ”¯æŒæŒ‰ asset åç§°æ¸…ç†ï¼Ÿ**
   - ä¾‹å¦‚ï¼š`calvin clean --asset my-workflow.md`

3. **æ¸…ç†åæ˜¯å¦è‡ªåŠ¨æ›´æ–°é”æ–‡ä»¶ï¼Ÿ**
   - å»ºè®®ï¼šæ˜¯ï¼Œä¿æŒé”æ–‡ä»¶ä¸å®é™…çŠ¶æ€ä¸€è‡´

4. **æ˜¯å¦è®°å½•æ¸…ç†æ—¥å¿—ï¼Ÿ**
   - ä¾¿äºå®¡è®¡å’Œå›æ»š

## Edge Cases & Failure Scenarios

### EC-1: å¤šé¡¹ç›®å…±äº« Home ç›®å½•éƒ¨ç½²

**åœºæ™¯**ï¼šé¡¹ç›® A å’Œé¡¹ç›® B éƒ½å‘ `~/.claude/commands/` éƒ¨ç½²äº†ä¸åŒçš„æ–‡ä»¶ã€‚

**é—®é¢˜**ï¼š

- ç”¨æˆ·åœ¨é¡¹ç›® A æ‰§è¡Œ `calvin clean --home`
- é¡¹ç›® A çš„é”æ–‡ä»¶åªè®°å½•äº†é¡¹ç›® A éƒ¨ç½²çš„æ–‡ä»¶
- é¡¹ç›® B çš„éƒ¨ç½²ä¸ä¼šè¢«å½±å“ï¼ˆæ­£ç¡®ï¼‰
- ä½†å¦‚æœä¸¤ä¸ªé¡¹ç›®éƒ¨ç½²äº†**åŒåæ–‡ä»¶**ï¼Ÿ

**å†³ç­–ç‚¹**ï¼š

- æ–¹æ¡ˆ Aï¼šæ¯ä¸ªé¡¹ç›®ç‹¬ç«‹ç®¡ç†ï¼Œåéƒ¨ç½²è€…è¦†ç›–å…ˆéƒ¨ç½²è€…
- æ–¹æ¡ˆ Bï¼šæ£€æµ‹å†²çªï¼Œæ‹’ç»è¦†ç›–ï¼ˆéœ€è¦å…¨å±€é”æ–‡ä»¶ï¼‰
- æ–¹æ¡ˆ Cï¼šåœ¨æ–‡ä»¶ç­¾åä¸­è®°å½•æ¥æºé¡¹ç›®ï¼Œæ¸…ç†æ—¶æ ¡éªŒ

**å»ºè®®**ï¼šæ–¹æ¡ˆ Aï¼ˆå½“å‰è¡Œä¸ºï¼‰ï¼Œä½†åœ¨æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜é£é™©ã€‚

---

### EC-2: é”æ–‡ä»¶ä¸¢å¤±æˆ–æŸå

**åœºæ™¯**ï¼šç”¨æˆ·åˆ é™¤äº† `.calvin.lock`ï¼Œæˆ–é”æ–‡ä»¶è¢«æ„å¤–æŸåã€‚

**é—®é¢˜**ï¼š`calvin clean` æ— æ³•çŸ¥é“å“ªäº›æ–‡ä»¶æ˜¯ç”± Calvin ç®¡ç†çš„ã€‚

**å¤„ç†æ–¹æ¡ˆ**ï¼š

1. æ£€æµ‹é”æ–‡ä»¶ä¸å­˜åœ¨æ—¶ï¼Œæ˜¾ç¤ºæ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
2. æä¾› `--scan` é€‰é¡¹ï¼šæ‰«æç›®æ ‡ç›®å½•ä¸­å¸¦æœ‰ Calvin ç­¾åçš„æ–‡ä»¶
3. å°†æ‰«æç»“æœå‘ˆç°ç»™ç”¨æˆ·ç¡®è®¤åæ‰§è¡Œ

**è¾“å‡ºç¤ºä¾‹**ï¼š

```text
âš ï¸  Lockfile not found: .promptpack/.calvin.lock

Calvin cannot determine which files it manages.

Options:
  1. Run `calvin deploy` first to regenerate the lockfile
  2. Use `calvin clean --scan` to find files with Calvin signature
  3. Manually delete files in target directories
```

---

### EC-3: æ–‡ä»¶è¢«ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹

**åœºæ™¯**ï¼šç”¨æˆ·ç¼–è¾‘äº† Calvin éƒ¨ç½²çš„æ–‡ä»¶ï¼ˆhash ä¸åŒ¹é…ï¼‰ã€‚

**é—®é¢˜**ï¼š

- è¿™ä¸ªæ–‡ä»¶è¿˜åº”è¯¥è¢« clean å—ï¼Ÿ
- ç”¨æˆ·å¯èƒ½å¿˜è®°äº†è‡ªå·±åšè¿‡ä¿®æ”¹

**å¤„ç†æ–¹æ¡ˆ**ï¼š

1. é»˜è®¤ï¼šæ£€æµ‹ hash ä¸åŒ¹é…æ—¶ï¼Œ**è·³è¿‡**å¹¶è­¦å‘Š
2. `--force`ï¼šå¼ºåˆ¶åˆ é™¤ï¼Œå³ä½¿ hash ä¸åŒ¹é…
3. äº¤äº’æ¨¡å¼ï¼šå•ç‹¬è¯¢é—®æ¯ä¸ªä¿®æ”¹è¿‡çš„æ–‡ä»¶

**è¾“å‡ºç¤ºä¾‹**ï¼š

```text
âš ï¸  Modified files detected (2 files):
    - ~/.claude/commands/my-workflow.md (modified 2 days ago)
    - ~/.cursor/rules/coding-style/rule.md (modified today)

These files have been changed since Calvin deployed them.
? How to handle modified files?
  > Skip modified files (keep user changes)
    Delete anyway (discard user changes)
    Ask for each file
```

---

### EC-4: é”æ–‡ä»¶è®°å½•çš„æ–‡ä»¶å·²ä¸å­˜åœ¨

**åœºæ™¯**ï¼šç”¨æˆ·æ‰‹åŠ¨åˆ é™¤äº†æŸäº› Calvin éƒ¨ç½²çš„æ–‡ä»¶ã€‚

**é—®é¢˜**ï¼šé”æ–‡ä»¶ä»è®°å½•è¿™äº›æ–‡ä»¶ï¼Œä½†æ–‡ä»¶å·²ä¸å­˜åœ¨ã€‚

**å¤„ç†æ–¹æ¡ˆ**ï¼š

1. é™é»˜è·³è¿‡ä¸å­˜åœ¨çš„æ–‡ä»¶
2. ä»é”æ–‡ä»¶ä¸­ç§»é™¤è¿™äº›è®°å½•ï¼ˆä¿æŒä¸€è‡´æ€§ï¼‰
3. åœ¨æŠ¥å‘Šä¸­æ˜¾ç¤º "Already missing: X files"

---

### EC-5: æƒé™é—®é¢˜å¯¼è‡´åˆ é™¤å¤±è´¥

**åœºæ™¯**ï¼šæŸäº›æ–‡ä»¶ç”±äºæƒé™ä¸è¶³æ— æ³•åˆ é™¤ã€‚

**é—®é¢˜**ï¼šéƒ¨åˆ†æ–‡ä»¶åˆ é™¤æˆåŠŸï¼Œéƒ¨åˆ†å¤±è´¥ã€‚

**å¤„ç†æ–¹æ¡ˆ**ï¼š

1. ç»§ç»­å¤„ç†å…¶ä»–æ–‡ä»¶ï¼Œæ”¶é›†æ‰€æœ‰å¤±è´¥
2. æœ€åæ±‡æ€»æŠ¥å‘Šå¤±è´¥çš„æ–‡ä»¶åŠåŸå› 
3. é”æ–‡ä»¶åªç§»é™¤æˆåŠŸåˆ é™¤çš„æ¡ç›®
4. å»ºè®®ç”¨æˆ·æ‰‹åŠ¨å¤„ç†å¤±è´¥çš„æ–‡ä»¶

**è¾“å‡ºç¤ºä¾‹**ï¼š

```text
âœ“ Cleaned 52/54 files

âœ— Failed to delete 2 files:
    - ~/.claude/commands/protected.md: Permission denied
    - ~/.cursor/rules/readonly/rule.md: Read-only file system

Lockfile updated (52 entries removed, 2 retained)
```

---

### EC-6: Asset Scope å˜æ›´

**åœºæ™¯**ï¼šç”¨æˆ·å°†æŸä¸ª asset çš„ scope ä» `user` æ”¹ä¸º `project`ï¼ˆæˆ–åè¿‡æ¥ï¼‰ã€‚

**é—®é¢˜**ï¼š

- æ—§ scope çš„æ–‡ä»¶å˜æˆå­¤å„¿
- æ–° scope éœ€è¦æ–°éƒ¨ç½²

**å¤„ç†æ–¹æ¡ˆ**ï¼š

1. `calvin deploy` å·²æœ‰çš„ `--cleanup` é€»è¾‘åº”è¯¥å¤„ç†è¿™ç§æƒ…å†µ
2. å­¤å„¿æ£€æµ‹éœ€è¦è€ƒè™‘ scope å˜åŒ–
3. `clean` å‘½ä»¤ä¸éœ€è¦ç‰¹æ®Šå¤„ç†ï¼ˆæŒ‰é”æ–‡ä»¶æ¸…ç†å³å¯ï¼‰

---

### EC-7: Remote éƒ¨ç½²çš„æ¸…ç†

**åœºæ™¯**ï¼šç”¨æˆ·ä½¿ç”¨ `calvin deploy --remote user@server:/path` éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨ã€‚

**é—®é¢˜**ï¼š`calvin clean` æ˜¯å¦éœ€è¦æ”¯æŒæ¸…ç†è¿œç¨‹ï¼Ÿ

**å†³ç­–ç‚¹**ï¼š

- æ–¹æ¡ˆ Aï¼šPhase 1 ä¸æ”¯æŒï¼Œåªæ”¯æŒæœ¬åœ°æ¸…ç†
- æ–¹æ¡ˆ Bï¼šæ”¯æŒ `calvin clean --remote user@server`

**å»ºè®®**ï¼šPhase 1 æš‚ä¸æ”¯æŒï¼Œé”æ–‡ä»¶ä¸­ remote éƒ¨ç½²ç”¨ `remote:` å‰ç¼€æ ‡è¯†ï¼Œclean æ—¶è·³è¿‡å¹¶æç¤ºã€‚

---

### EC-8: Watch æ¨¡å¼è¿è¡Œæ—¶æ‰§è¡Œ Clean

**åœºæ™¯**ï¼š`calvin watch` æ­£åœ¨è¿è¡Œï¼Œç”¨æˆ·åœ¨å¦ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œ `calvin clean`ã€‚

**é—®é¢˜**ï¼š

- Watch ä¼šæ£€æµ‹åˆ°æ–‡ä»¶åˆ é™¤ï¼Œå¯èƒ½è§¦å‘é‡æ–°åŒæ­¥
- é”æ–‡ä»¶å¯èƒ½è¢«ä¸¤è¾¹åŒæ—¶ä¿®æ”¹

**å¤„ç†æ–¹æ¡ˆ**ï¼š

1. ä½¿ç”¨æ–‡ä»¶é”é˜²æ­¢å¹¶å‘ä¿®æ”¹é”æ–‡ä»¶
2. `clean` å¼€å§‹å‰æ£€æµ‹æ˜¯å¦æœ‰ watch è¿›ç¨‹
3. å¦‚æœæ£€æµ‹åˆ°ï¼Œè­¦å‘Šç”¨æˆ·å¹¶å»ºè®®å…ˆåœæ­¢ watch

---

### EC-9: `enabled = []` ç©ºåˆ—è¡¨

**åœºæ™¯**ï¼šç”¨æˆ·å°† `config.toml` ä¸­çš„ `targets.enabled` è®¾ä¸ºç©ºåˆ—è¡¨ã€‚

**é—®é¢˜**ï¼š

- è¿™æ˜¯å¦æ„å‘³ç€"ç¦ç”¨æ‰€æœ‰ target"ï¼Ÿ
- `deploy` åº”è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ
- è‡ªåŠ¨æ¸…ç†æ£€æµ‹åº”è¯¥è§¦å‘å—ï¼Ÿ

**å¤„ç†æ–¹æ¡ˆ**ï¼š

1. `enabled = []` è¡¨ç¤º"ä¸éƒ¨ç½²åˆ°ä»»ä½• target"
2. å¦‚æœé”æ–‡ä»¶ä¸­æœ‰å·²éƒ¨ç½²çš„ targetsï¼Œè§¦å‘æ¸…ç†æç¤º
3. ä¸ `enabled` å­—æ®µç¼ºå¤±ä¸åŒï¼ˆç¼ºå¤± = ä½¿ç”¨é»˜è®¤å€¼ = allï¼‰

---

### EC-10: æ¸…ç†åçš„å›æ»šéœ€æ±‚

**åœºæ™¯**ï¼šç”¨æˆ·æ‰§è¡Œ clean åå‘ç°è¯¯åˆ ï¼Œæƒ³è¦æ¢å¤ã€‚

**é—®é¢˜**ï¼šå·²åˆ é™¤çš„æ–‡ä»¶æ— æ³•æ¢å¤ã€‚

**å¤„ç†æ–¹æ¡ˆ**ï¼š

- æ–¹æ¡ˆ Aï¼šåˆ é™¤å‰è‡ªåŠ¨å¤‡ä»½åˆ° `.calvin/backup/`
- æ–¹æ¡ˆ Bï¼šä¾èµ– `calvin deploy` é‡æ–°éƒ¨ç½²ï¼ˆæ¨èï¼‰
- æ–¹æ¡ˆ Cï¼šä»… `--dry-run` è¶³å¤Ÿï¼Œä¸æä¾›å›æ»š

**å»ºè®®**ï¼šæ–¹æ¡ˆ Bï¼Œåœ¨ clean å®Œæˆåæç¤º "Run `calvin deploy` to re-deploy"ã€‚

---

### EC-11: è·¨ç‰ˆæœ¬é”æ–‡ä»¶å…¼å®¹

**åœºæ™¯**ï¼šç”¨æˆ·å‡çº§ Calvin ç‰ˆæœ¬ï¼Œé”æ–‡ä»¶æ ¼å¼å¯èƒ½å˜åŒ–ã€‚

**é—®é¢˜**ï¼š

- æ—§ç‰ˆé”æ–‡ä»¶ç¼ºå°‘ `target` å­—æ®µ
- æ–°ç‰ˆ clean æ— æ³•æŒ‰ target è¿‡æ»¤

**å¤„ç†æ–¹æ¡ˆ**ï¼š

1. å®ç°é”æ–‡ä»¶ç‰ˆæœ¬å·ï¼ˆ`format_version`ï¼‰
2. æ—§æ ¼å¼è‡ªåŠ¨è¿ç§»ï¼ˆåœ¨éœ€è¦æ—¶ï¼‰
3. ç¼ºå¤±å­—æ®µä½¿ç”¨åˆç†çš„é»˜è®¤å€¼æˆ–è·³è¿‡è¯¥åŠŸèƒ½

---

### EC-12: æ–‡ä»¶è·¯å¾„å†²çª

**åœºæ™¯**ï¼šç”¨æˆ·æ‰‹åŠ¨åˆ›å»ºäº†ä¸ Calvin éƒ¨ç½²è·¯å¾„ç›¸åŒçš„æ–‡ä»¶ï¼ˆæ—  Calvin ç­¾åï¼‰ã€‚

**é—®é¢˜**ï¼š

- é”æ–‡ä»¶è®°å½•äº†è¿™ä¸ªè·¯å¾„
- ä½†æ–‡ä»¶ä¸åŒ…å« Calvin ç­¾åï¼ˆå¯èƒ½æ˜¯ç”¨æˆ·è¦†ç›–çš„ï¼‰

**å¤„ç†æ–¹æ¡ˆ**ï¼š

1. ç­¾åéªŒè¯å¤±è´¥ â†’ è§†ä¸º"ç”¨æˆ·ä¿®æ”¹"åœºæ™¯
2. é»˜è®¤è·³è¿‡ï¼Œé™¤é `--force`
3. ä»é”æ–‡ä»¶ç§»é™¤è¯¥æ¡ç›®ï¼ˆæ–‡ä»¶ä¸å†ç”± Calvin ç®¡ç†ï¼‰

---

### EC-13: Symlink å¤„ç†

**åœºæ™¯**ï¼š

- Calvin éƒ¨ç½²çš„æ–‡ä»¶æ˜¯ symlink
- æˆ–ç›®æ ‡ç›®å½•æœ¬èº«æ˜¯ symlink

**å¤„ç†æ–¹æ¡ˆ**ï¼š

1. åˆ é™¤ symlink æœ¬èº«ï¼Œä¸è·Ÿéšé“¾æ¥
2. å¦‚æœç›®æ ‡ç›®å½•æ˜¯ symlinkï¼Œä½¿ç”¨ resolved è·¯å¾„
3. åœ¨é”æ–‡ä»¶ä¸­è®°å½• canonical path

---

### EC-14: é‡å¤æ£€æµ‹ç–²åŠ³

**åœºæ™¯**ï¼šç”¨æˆ·ç¦ç”¨äº†æŸä¸ª targetï¼Œæ¯æ¬¡ deploy éƒ½è¢«è¯¢é—®æ˜¯å¦æ¸…ç†ï¼Œä½†æ¯æ¬¡éƒ½é€‰æ‹©"è·³è¿‡"ã€‚

**é—®é¢˜**ï¼šé‡å¤æç¤ºé€ æˆéªšæ‰°ã€‚

**å¤„ç†æ–¹æ¡ˆ**ï¼š

1. è®°å½•ç”¨æˆ·é€‰æ‹©åˆ°é”æ–‡ä»¶ï¼ˆ`skip_cleanup_for = ["cursor"]`ï¼‰
2. ä¸‹æ¬¡ deploy ä¸å†æç¤ºè¯¥ target
3. ç›´åˆ°ç”¨æˆ·é‡æ–° enable è¯¥ target æˆ–æ‰‹åŠ¨æ‰§è¡Œ clean

---

### EC-15: Target ä»æœªéƒ¨ç½²

**åœºæ™¯**ï¼šç”¨æˆ·æ‰§è¡Œ `calvin clean --target cursor`ï¼Œä½†ä»æœªéƒ¨ç½²è¿‡ Cursorã€‚

**å¤„ç†æ–¹æ¡ˆ**ï¼š

1. æ£€æµ‹é”æ–‡ä»¶ä¸­æ²¡æœ‰ cursor çš„è®°å½•
2. æ˜¾ç¤ºä¿¡æ¯ï¼š"No Cursor deployments found. Nothing to clean."
3. æ­£å¸¸é€€å‡ºï¼ˆexit code 0ï¼‰

---

### EC-16: éƒ¨åˆ† Target æ¸…ç†å¤±è´¥

**åœºæ™¯**ï¼šæ¸…ç†å¤šä¸ª targets æ—¶ï¼ŒCursor æˆåŠŸä½† Claude å¤±è´¥ã€‚

**å¤„ç†æ–¹æ¡ˆ**ï¼š

1. ç»§ç»­å¤„ç†å…¶ä»– targets
2. æ±‡æ€»æ‰€æœ‰ç»“æœ
3. å¦‚æœæœ‰ä»»ä½•å¤±è´¥ï¼Œexit code éé›¶
4. é”æ–‡ä»¶åªæ›´æ–°æˆåŠŸçš„éƒ¨åˆ†

---

### EC-17: CI/CD ç¯å¢ƒä¸‹çš„æ¸…ç†

**åœºæ™¯**ï¼šåœ¨ CI ä¸­æ‰§è¡Œ `calvin clean` ç”¨äºæ¸…ç†æµ‹è¯•ç¯å¢ƒã€‚

**éœ€æ±‚**ï¼š

1. æ”¯æŒ `--yes` è·³è¿‡æ‰€æœ‰ç¡®è®¤
2. æ”¯æŒ `--json` è¾“å‡ºæœºå™¨å¯è§£æçš„ç»“æœ
3. æ˜ç¡®çš„ exit codesï¼ˆ0=æˆåŠŸ, 1=éƒ¨åˆ†å¤±è´¥, 2=å®Œå…¨å¤±è´¥ï¼‰

---

## Decision Matrix

| Edge Case | é»˜è®¤è¡Œä¸º | `--force` è¡Œä¸º | éœ€è¦ç”¨æˆ·ç¡®è®¤ |
|-----------|---------|---------------|-------------|
| EC-3: æ–‡ä»¶è¢«ä¿®æ”¹ | è·³è¿‡ | åˆ é™¤ | æ˜¯ï¼ˆäº¤äº’æ¨¡å¼ï¼‰ |
| EC-4: æ–‡ä»¶å·²ä¸å­˜åœ¨ | é™é»˜è·³è¿‡ | åŒå·¦ | å¦ |
| EC-5: æƒé™ä¸è¶³ | è·³è¿‡+æŠ¥å‘Š | åŒå·¦ | å¦ |
| EC-7: Remote éƒ¨ç½² | è·³è¿‡+æç¤º | åŒå·¦ | å¦ |
| EC-12: æ— ç­¾å | è·³è¿‡ | åˆ é™¤ | æ˜¯ |

## Success Metrics

- ç”¨æˆ·èƒ½åœ¨ 30 ç§’å†…å®Œæˆ home ç›®å½•æ¸…ç†
- é›¶è¯¯åˆ é Calvin ç®¡ç†çš„æ–‡ä»¶
- äº¤äº’æ¨¡å¼çš„ç”¨æˆ·æ»¡æ„åº¦ > 90%

## Rollout Plan

1. **Phase 1**: å®ç°åŸºç¡€ `clean` å‘½ä»¤ï¼ˆ--home, --target, --dry-runï¼‰
2. **Phase 2**: æ·»åŠ äº¤äº’å¼æ¨¡å¼
3. **Phase 3**: é›†æˆåˆ° `deploy` å‘½ä»¤çš„è‡ªåŠ¨æ£€æµ‹

---

## Appendix: Current Lockfile Structure

```toml
[files."home:~/.claude/commands/my-workflow.md"]
hash = "sha256:abc123..."
source = "workflows/my-workflow.md"
target = "claude-code"     # æ–°å¢ï¼šè®°å½• target
scope = "user"             # æ–°å¢ï¼šè®°å½• scope

[files."project:.claude/commands/my-workflow.md"]  
hash = "sha256:def456..."
source = "workflows/my-workflow.md"
target = "claude-code"
scope = "project"
```

æ³¨æ„ï¼šå½“å‰é”æ–‡ä»¶å¯èƒ½æœªåŒ…å« `target` å’Œ `scope` å­—æ®µï¼Œéœ€è¦è¯„ä¼°æ˜¯å¦éœ€è¦è¿ç§»ã€‚
