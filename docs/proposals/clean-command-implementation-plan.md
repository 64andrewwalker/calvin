# Clean Command Implementation Plan

> **Status**: Draft  
> **Created**: 2025-12-23  
> **Based on**: [clean-command-prd.md](clean-command-prd.md)  
> **Approach**: TDD (Test-Driven Development)

## Overview

使用 TDD 方式分阶段实现 `calvin clean` 命令。每个功能点遵循 RED → GREEN → REFACTOR 循环。

---

## Phase 1: 基础 Clean 命令

### 1.1 CLI 解析

**目标**: 添加 `clean` 子命令到 CLI。

**TDD 步骤**:

1. **RED**: 编写测试验证 `calvin clean --help` 输出
2. **GREEN**: 添加 `Commands::Clean` 枚举变体  
3. **REFACTOR**: 确保与现有 CLI 结构一致

**Files**:

- `src/presentation/cli.rs` - 添加 Clean 命令定义
- `tests/cli_clean.rs` - 集成测试

**Tests**:

```rust
#[test]
fn clean_help_shows_options() {
    let output = Command::new(bin).args(["clean", "--help"]).output();
    let stdout = String::from_utf8_lossy(&output.stdout);
    assert!(stdout.contains("--home"));
    assert!(stdout.contains("--project"));
    assert!(stdout.contains("--dry-run"));
    assert!(stdout.contains("--yes"));
}
```

---

### 1.2 CleanUseCase 核心逻辑

**目标**: 实现清理用例的业务逻辑。

**TDD 步骤**:

1. **RED**: 编写 `CleanUseCase` 单元测试
2. **GREEN**: 实现 `CleanUseCase::execute()`
3. **REFACTOR**: 提取 `CleanOptions` 和 `CleanResult`

**Files**:

- `src/application/clean/mod.rs` - 模块定义
- `src/application/clean/use_case.rs` - CleanUseCase
- `src/application/clean/options.rs` - CleanOptions
- `src/application/clean/result.rs` - CleanResult

**Domain Types**:

```rust
pub struct CleanOptions {
    pub scope: Option<Scope>,  // None = all, Some = filter
    pub dry_run: bool,
    pub force: bool,
}

pub struct CleanResult {
    pub deleted: Vec<PathBuf>,
    pub skipped: Vec<SkippedFile>,
    pub errors: Vec<CleanError>,
}

pub enum SkipReason {
    Modified,       // EC-3: hash mismatch
    Missing,        // EC-4: file not found
    NoSignature,    // EC-12: no Calvin signature
    Permission,     // EC-5: permission denied
    Remote,         // EC-7: remote deployment
}
```

**Tests**:

```rust
#[test]
fn clean_deletes_files_from_lockfile() {
    // Setup: lockfile with 2 entries, files exist
    // Act: CleanUseCase::execute(options)
    // Assert: files deleted, lockfile updated
}

#[test]
fn clean_skips_modified_files() {
    // Setup: file content differs from lockfile hash
    // Act: execute with force=false
    // Assert: file skipped, in skipped list with reason
}

#[test]
fn clean_dry_run_does_not_delete() {
    // Setup: lockfile with entries
    // Act: execute with dry_run=true
    // Assert: files still exist, result shows what would be deleted
}
```

---

### 1.3 Lockfile 读取与更新

**目标**: 实现从 lockfile 读取部署信息，删除后更新。

**TDD 步骤**:

1. **RED**: 测试 `Lockfile::entries_by_scope(Scope::User)`
2. **GREEN**: 实现过滤逻辑
3. **REFACTOR**: 优化 API 设计

**Files**:

- `src/domain/entities/lockfile.rs` - 扩展 Lockfile

**Tests**:

```rust
#[test]
fn lockfile_entries_by_scope_user() {
    let lockfile = Lockfile::from_str(r#"
        [files]
        "home:~/.claude/cmd.md" = { hash = "sha256:abc" }
        "project:.cursor/rule.md" = { hash = "sha256:def" }
    "#);
    
    let user_entries = lockfile.entries_by_scope(Scope::User);
    assert_eq!(user_entries.len(), 1);
    assert!(user_entries[0].key.starts_with("home:"));
}
```

---

### 1.4 签名验证

**目标**: 验证文件包含 Calvin 签名后才允许删除。

**TDD 步骤**:

1. **RED**: 测试 `has_calvin_signature(path)`
2. **GREEN**: 实现签名检测
3. **REFACTOR**: 提取签名模式到常量

**Files**:

- `src/domain/services/signature.rs` - 签名验证服务

**Tests**:

```rust
#[test]
fn detects_calvin_signature() {
    let content = "# Generated by Calvin\n\ncontent";
    assert!(has_calvin_signature(content));
}

#[test]
fn rejects_file_without_signature() {
    let content = "# My custom file\ncontent";
    assert!(!has_calvin_signature(content));
}
```

---

### 1.5 命令处理器集成

**目标**: 连接 CLI 到 UseCase。

**Files**:

- `src/commands/clean.rs` - 命令处理器
- `src/main.rs` - 添加 dispatch 分支

**Integration Test**:

```rust
#[test]
fn clean_home_removes_files() {
    let dir = create_test_project();
    // Deploy first
    Command::new(bin).args(["deploy", "--yes"]).current_dir(&dir).output();
    
    // Verify files exist
    assert!(dir.path().join(".claude/commands/test.md").exists());
    
    // Clean
    let output = Command::new(bin)
        .args(["clean", "--home", "--yes"])
        .current_dir(&dir)
        .output()
        .unwrap();
    
    assert!(output.status.success());
    // Verify files removed (or use --dry-run for home)
}
```

---

## Phase 2: 交互式树形菜单

### 2.1 TreeMenu 组件

**目标**: 实现多级树形选择菜单。

**Files**:

- `src/ui/widgets/tree_menu.rs` - 树形菜单组件

**Data Structure**:

```rust
pub struct TreeNode {
    pub label: String,
    pub state: SelectionState,
    pub children: Vec<TreeNode>,
    pub expanded: bool,
    pub data: Option<PathBuf>,  // Leaf 节点存储文件路径
}

pub enum SelectionState {
    Selected,    // ●
    Unselected,  // ○
    Partial,     // ◐
}
```

**Tests**:

```rust
#[test]
fn selecting_parent_selects_all_children() {
    let mut tree = TreeNode::from_lockfile(&lockfile);
    tree.select();
    assert!(tree.children.iter().all(|c| c.state == Selected));
}

#[test]
fn partial_child_selection_shows_partial_parent() {
    let mut tree = TreeNode::from_lockfile(&lockfile);
    tree.children[0].select();
    assert_eq!(tree.state, SelectionState::Partial);
}
```

---

### 2.2 交互式渲染

**Files**:

- `src/ui/views/clean.rs` - Clean 视图

**Keyboard Handling**:

```rust
pub enum TreeAction {
    Up,
    Down,
    Toggle,       // Space
    Expand,       // → or Enter
    Collapse,     // ← or Backspace
    SelectAll,    // a
    SelectNone,   // n
    Invert,       // i
    Confirm,      // Enter on confirm
    Quit,         // q
}
```

---

## Phase 3: Lockfile 扩展 (可选)

### 3.1 添加 target 字段

**目标**: 扩展 lockfile 结构支持 `target` 过滤。

**Files**:

- `src/domain/entities/lockfile.rs` - 扩展结构

**Migration**:

```rust
// 检测旧格式并迁移
if lockfile.format_version < 2 {
    lockfile.infer_targets_from_paths();
    lockfile.format_version = 2;
    lockfile.save();
}
```

---

## Verification Checklist

### Unit Tests

- [ ] `CleanOptions` construction
- [ ] `CleanUseCase::execute()` with various scenarios
- [ ] `Lockfile::entries_by_scope()`
- [ ] `has_calvin_signature()`
- [ ] `TreeNode` selection logic

### Integration Tests

- [ ] `calvin clean --help`
- [ ] `calvin clean --dry-run`
- [ ] `calvin clean --home --yes`
- [ ] `calvin clean --project --yes`
- [ ] Interactive mode (manual testing)

### Edge Cases

- [ ] EC-2: Lockfile missing → error message
- [ ] EC-3: Modified files → skip with warning
- [ ] EC-4: Missing files → silent skip
- [ ] EC-5: Permission denied → continue, report
- [ ] EC-12: No signature → skip

---

## File Structure

```
src/
├── application/
│   └── clean/
│       ├── mod.rs
│       ├── use_case.rs      # CleanUseCase
│       ├── options.rs       # CleanOptions
│       └── result.rs        # CleanResult
├── commands/
│   └── clean.rs             # cmd_clean()
├── domain/
│   └── services/
│       └── signature.rs     # has_calvin_signature()
├── presentation/
│   └── cli.rs               # Commands::Clean
└── ui/
    ├── widgets/
    │   └── tree_menu.rs     # TreeNode, TreeMenu
    └── views/
        └── clean.rs         # render_clean_view()

tests/
└── cli_clean.rs             # Integration tests
```

---

## Dependencies

无新增依赖，使用现有：

- `dialoguer` - 用于 Confirm 提示
- `crossterm` - 用于 TreeMenu 键盘处理

---

## References

- [clean-command-prd.md](clean-command-prd.md) - 产品需求文档
- [4-test-tdd workflow](/.agent/workflows/4-test-tdd.md) - TDD 工作流
