# Calvin CLI 状态机规范

> **版本**: 1.0  
> **日期**: 2025-12-17  
> **目的**: 完整定义 CLI 所有状态、转换和错误处理，确保无意外行为

---

## 1. 全局状态机概览

```
                                    ┌─────────────────────────────────────────────────────────────────────┐
                                    │                         CALVIN CLI                                  │
                                    │                                                                     │
    ┌─────────┐                     │  ┌─────────────┐      ┌──────────────┐      ┌────────────────┐      │
    │  START  │────parse args───────┼─▶│  DISPATCH   │──────▶   COMMAND    │──────▶    EXIT        │      │
    └─────────┘                     │  │             │      │   HANDLER    │      │  (code 0/1/2)  │      │
        │                           │  └──────┬──────┘      └──────────────┘      └────────────────┘      │
        │                           │         │                                                           │
        ▼                           │         ▼ (parse error)                                             │
   ┌─────────────┐                  │  ┌─────────────┐                                                    │
   │ PARSE ERROR │◀─────────────────┼──│  HELP/      │                                                    │
   │  (exit 2)   │                  │  │  VERSION    │                                                    │
   └─────────────┘                  │  └─────────────┘                                                    │
                                    └─────────────────────────────────────────────────────────────────────┘
```

---

## 2. 退出码定义

| 退出码 | 名称 | 触发条件 | 示例 |
|--------|------|----------|------|
| `0` | SUCCESS | 命令正常完成 | `deploy` 无错误 |
| `1` | ERROR | 运行时错误或验证失败 | `check` 发现问题 |
| `2` | USAGE | 参数解析失败 | 未知命令/参数 |

---

## 3. 命令状态机详解

### 3.1 `calvin deploy`

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    DEPLOY COMMAND                                        │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌───────────┐                                                                         │
│   │   INIT    │                                                                         │
│   └─────┬─────┘                                                                         │
│         │                                                                               │
│         ▼                                                                               │
│   ┌───────────────┐    source不存在     ┌─────────────┐                                  │
│   │ VALIDATE_PATH │────────────────────▶│    ERROR    │──▶ exit(1)                      │
│   └───────┬───────┘                     │ "not found" │                                 │
│           │ ok                          └─────────────┘                                 │
│           ▼                                                                             │
│   ┌───────────────┐    config无效       ┌─────────────┐                                  │
│   │  LOAD_CONFIG  │───ⓦ warning───────▶│ USE_DEFAULT │                                 │
│   └───────┬───────┘                     └──────┬──────┘                                 │
│           │ ok                                 │                                        │
│           ├◀───────────────────────────────────┘                                        │
│           ▼                                                                             │
│   ┌───────────────┐    parse失败        ┌─────────────┐                                  │
│   │  PARSE_ASSETS │────────────────────▶│    ERROR    │──▶ exit(1)                     │
│   └───────┬───────┘                     │"parse fail" │                                │
│           │ ok                          └─────────────┘                                │
│           ▼                                                                            │
│   ┌───────────────┐    编译失败          ┌─────────────┐                                │
│   │   COMPILE     │────────────────────▶│    ERROR    │──▶ exit(1)                     │
│   └───────┬───────┘                     │"compile err"│                                │
│           │ ok                          └─────────────┘                                │
│           ▼                                                                            │
│   ┌───────────────────────────────────────────────────────────────────────────────┐    │
│   │                           SYNC_LOOP (for each output)                          │    │
│   │  ┌─────────────────┐                                                           │    │
│   │  │ CHECK_FILE_STATE│                                                           │    │
│   │  └────────┬────────┘                                                           │    │
│   │           │                                                                    │    │
│   │     ┌─────┴─────┬────────────────┐                                             │    │
│   │     ▼           ▼                ▼                                             │    │
│   │ [不存在]    [已存在+锁定]    [已存在+未锁定]                                        │    │
│   │     │           │                │                                             │    │
│   │     │     ┌─────┴─────┐          │                                             │    │
│   │     │     ▼           ▼          │                                             │    │
│   │     │ [hash匹配]  [hash不匹配]    │                                             │    │
│   │     │     │           │          │                                             │    │
│   │     │     │     ┌─────┴─────┐    │                                             │    │
│   │     │     │     ▼           ▼    │                                             │    │
│   │     │     │ [--force]  [no force]│                                             │    │
│   │     │     │     │           │    │                                             │    │
│   │     ▼     ▼     ▼           ▼    ▼                                             │    │
│   │   WRITE   WRITE  WRITE    SKIP  SKIP+WARN                                      │    │
│   │     │       │      │        │      │                                           │    │
│   │     └───────┴──────┴────────┴──────┘                                           │    │
│   │                     │                                                          │    │
│   │                     ▼                                                          │    │
│   │              UPDATE_LOCKFILE                                                   │    │
│   └───────────────────────────────────────────────────────────────────────────────┘    │
│           │                                                                            │
│           ▼                                                                            │
│   ┌───────────────┐         ┌───────────────┐                                         │
│   │ GENERATE_REPORT│────────▶│    EXIT(0)    │                                         │
│   └───────────────┘         │  or EXIT(1)   │ ← if errors.len() > 0                    │
│                             └───────────────┘                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

**状态说明**:

| 状态 | 描述 | 可能转换 |
|------|------|----------|
| INIT | 初始化命令 | → VALIDATE_PATH |
| VALIDATE_PATH | 检查 source 目录存在 | → LOAD_CONFIG, → ERROR |
| LOAD_CONFIG | 加载 config.toml | → PARSE_ASSETS (ok/default) |
| PARSE_ASSETS | 解析 .promptpack 文件 | → COMPILE, → ERROR |
| COMPILE | 编译到各平台格式 | → SYNC_LOOP, → ERROR |
| CHECK_FILE_STATE | 检查目标文件状态 | → WRITE, → SKIP |
| PROMPT_CONFLICT | 交互确认冲突 | → WRITE, → SKIP, → ERROR |
| SHOW_DIFF | 显示 unified diff | → PROMPT_CONFLICT |
| WRITE | 原子写入文件 | → UPDATE_LOCKFILE |
| SKIP | 跳过文件 | → UPDATE_LOCKFILE |
| UPDATE_LOCKFILE | 更新 .calvin.lock | → next file / REPORT |
| GENERATE_REPORT | 生成结果报告 | → EXIT |

**选项影响**:

| 选项 | 影响的状态 | 行为变化 |
|------|-----------|----------|
| `--force` | CHECK_FILE_STATE | hash 不匹配时也写入 |
| `--yes` | CHECK_FILE_STATE | 非交互；冲突自动覆盖（等价于选择 overwrite all） |
| `--dry-run` | WRITE | 不实际写入，仅报告 |
| `--remote` | WRITE | 使用 RemoteFileSystem |

---

### 3.2 `calvin watch`

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                     WATCH COMMAND                                        │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌───────────┐                                                                         │
│   │   INIT    │                                                                         │
│   └─────┬─────┘                                                                         │
│         │                                                                               │
│         ▼                                                                               │
│   ┌───────────────┐                                                                     │
│   │  SETUP_WATCHER│                                                                     │
│   └───────┬───────┘                                                                     │
│           │                                                                             │
│           ▼                                                                             │
│   ┌────────────────────────────────────────────────────────────────────────────────┐   │
│   │                              WATCH_LOOP                                         │   │
│   │                                                                                 │   │
│   │    ┌───────────────┐                                                            │   │
│   │    │  IDLE_WAIT    │◀──────────────────────────────────────────┐               │   │
│   │    └───────┬───────┘                                           │               │   │
│   │            │                                                   │               │   │
│   │      ┌─────┴─────┬───────────────────┐                         │               │   │
│   │      ▼           ▼                   ▼                         │               │   │
│   │  [file_event] [ctrl-c]          [timeout]                      │               │   │
│   │      │           │                   │                         │               │   │
│   │      ▼           ▼                   │                         │               │   │
│   │  ┌─────────┐  ┌──────────┐           │                         │               │   │
│   │  │DEBOUNCE │  │ SHUTDOWN │           │                         │               │   │
│   │  │ (100ms) │  └────┬─────┘           │                         │               │   │
│   │  └────┬────┘       │                 │                         │               │   │
│   │       │            ▼                 │                         │               │   │
│   │       │      ┌───────────┐           │                         │               │   │
│   │       │      │  EXIT(0)  │           │                         │               │   │
│   │       │      └───────────┘           │                         │               │   │
│   │       ▼                              │                         │               │   │
│   │  ┌─────────────────┐                 │                         │               │   │
│   │  │ INCREMENTAL_PARSE│                │                         │               │   │
│   │  └────────┬────────┘                 │                         │               │   │
│   │           │                          │                         │               │   │
│   │           ▼                          │                         │               │   │
│   │  ┌─────────────────┐                 │                         │               │   │
│   │  │    COMPILE      │                 │                         │               │   │
│   │  └────────┬────────┘                 │                         │               │   │
│   │           │                          │                         │               │   │
│   │           ▼                          │                         │               │   │
│   │  ┌─────────────────┐                 │                         │               │   │
│   │  │   SYNC_OUTPUTS  │                 │                         │               │   │
│   │  └────────┬────────┘                 │                         │               │   │
│   │           │                          │                         │               │   │
│   │           ▼                          │                         │               │   │
│   │  ┌─────────────────┐                 │                         │               │   │
│   │  │  EMIT_EVENT     │─────────────────┴─────────────────────────┘               │   │
│   │  └─────────────────┘                                                            │   │
│   └────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

**事件类型 (WatchEvent)**:

| 事件 | 触发条件 | JSON 输出 |
|------|----------|-----------|
| `Started` | watcher 初始化完成 | `{"event":"started","source":"..."}` |
| `FileChanged` | 检测到文件变化 | `{"event":"file_changed","path":"..."}` |
| `SyncStarted` | 开始同步 | `{"event":"sync_started"}` |
| `SyncComplete` | 同步完成 | `{"event":"sync_complete","written":N,"skipped":N,"errors":N}` |
| `Error` | 发生错误 | `{"event":"error","message":"..."}` |
| `Shutdown` | 收到 SIGINT | `{"event":"shutdown"}` |

---

### 3.3 `calvin diff`

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                 DIFF COMMAND                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌───────────┐                                                             │
│   │   INIT    │                                                             │
│   └─────┬─────┘                                                             │
│         │                                                                   │
│         ▼                                                                   │
│   ┌───────────────┐    失败     ┌─────────────┐                             │
│   │ PARSE_ASSETS  │───────────▶│   ERROR     │──▶ exit(1)                  │
│   └───────┬───────┘            └─────────────┘                             │
│           │ ok                                                              │
│           ▼                                                                 │
│   ┌───────────────┐                                                         │
│   │   COMPILE     │                                                         │
│   └───────┬───────┘                                                         │
│           │                                                                 │
│           ▼                                                                 │
│   ┌────────────────────────────────────────────────────────────────────┐   │
│   │                    COMPARE_LOOP (for each output)                   │   │
│   │                                                                     │   │
│   │   ┌───────────────┐                                                 │   │
│   │   │ CHECK_TARGET  │                                                 │   │
│   │   └───────┬───────┘                                                 │   │
│   │           │                                                         │   │
│   │     ┌─────┴─────┬────────────────┐                                  │   │
│   │     ▼           ▼                ▼                                  │   │
│   │ [不存在]    [存在+相同]     [存在+不同]                               │   │
│   │     │           │                │                                  │   │
│   │     ▼           ▼                ▼                                  │   │
│   │  ADD_NEW    ADD_UNCHANGED   ADD_MODIFIED                            │   │
│   │     │           │                │                                  │   │
│   │     └───────────┴────────────────┘                                  │   │
│   │                     │                                               │   │
│   └─────────────────────┼───────────────────────────────────────────────┘   │
│                         ▼                                                   │
│   ┌───────────────┐         ┌───────────────┐                              │
│   │ GENERATE_REPORT│────────▶│    EXIT(0)    │                              │
│   └───────────────┘         └───────────────┘                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**输出分类**:

| 分类 | 符号 | 含义 |
|------|------|------|
| new | `+` | 目标文件不存在 |
| modified | `~` | 内容不同 |
| unchanged | `✓` | 内容相同 |

---

### 3.4 `calvin check`

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                 CHECK COMMAND                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌───────────┐                                                             │
│   │   INIT    │                                                             │
│   └─────┬─────┘                                                             │
│         │                                                                   │
│         ▼                                                                   │
│   ┌───────────────┐                                                         │
│   │ PARSE_MODE    │  "yolo" | "balanced" | "strict"                        │
│   └───────┬───────┘                                                         │
│           │                                                                 │
│           ▼                                                                 │
│   ┌────────────────────────────────────────────────────────────────────┐   │
│   │                    RUN_CHECKS                                       │   │
│   │                                                                     │   │
│   │   ┌───────────────────┐                                             │   │
│   │   │ CHECK_CLAUDE_CODE │                                             │   │
│   │   │  • commands dir   │                                             │   │
│   │   │  • settings.json  │                                             │   │
│   │   │  • deny list      │                                             │   │
│   │   └─────────┬─────────┘                                             │   │
│   │             ▼                                                       │   │
│   │   ┌───────────────────┐                                             │   │
│   │   │  CHECK_CURSOR     │                                             │   │
│   │   │  • rules dir      │                                             │   │
│   │   │  • mcp.json       │                                             │   │
│   │   │  • MCP allowlist  │                                             │   │
│   │   └─────────┬─────────┘                                             │   │
│   │             ▼                                                       │   │
│   │   ┌───────────────────┐                                             │   │
│   │   │  CHECK_VSCODE     │                                             │   │
│   │   │  • instructions   │                                             │   │
│   │   │  • AGENTS.md      │                                             │   │
│   │   └─────────┬─────────┘                                             │   │
│   │             ▼                                                       │   │
│   │   ┌───────────────────┐                                             │   │
│   │   │CHECK_ANTIGRAVITY  │                                             │   │
│   │   │  • rules dir      │                                             │   │
│   │   │  • workflows      │                                             │   │
│   │   │  • turbo mode     │                                             │   │
│   │   └───────────────────┘                                             │   │
│   │                                                                     │   │
│   └────────────────────────────────────────────────────────────────────┘   │
│           │                                                                 │
│           ▼                                                                 │
│   ┌───────────────┐         ┌───────────────┐                              │
│   │ GENERATE_REPORT│────────▶│   EXIT(0/1)   │                              │
│   └───────────────┘         └───────────────┘                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**检查结果行为 (按模式)**:

| 检查项 | yolo | balanced | strict |
|--------|------|----------|--------|
| 缺少 deny list | PASS | WARNING | ERROR |
| deny list 不完整 | PASS | WARNING | ERROR |
| 未知 MCP server | PASS | WARNING | WARNING |
| Turbo 模式 | - | - | WARNING |
| 缺少目录 | PASS | WARNING | WARNING |

**Verbose 输出 (`-v`)**:
- 显示部分检查的额外细节（例如 Cursor 的每个 MCP server 是命中 built-in allowlist 还是 custom allowlist）

---

### 3.5 `calvin check --strict-warnings`

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           CHECK (CI) COMMAND                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌───────────┐                                                             │
│   │   INIT    │                                                             │
│   └─────┬─────┘                                                             │
│         │                                                                   │
│         ▼                                                                   │
│   ┌───────────────┐                                                         │
│   │  RUN_DOCTOR   │  (same checks as `check`)                               │
│   └───────┬───────┘                                                         │
│           │                                                                 │
│           ▼                                                                 │
│   ┌───────────────────────────────────────────────────────────────────┐    │
│   │                    EVALUATE_RESULT                                 │    │
│   │                                                                    │    │
│   │   has_errors = report.errors() > 0                                 │    │
│   │   has_warnings = report.warnings() > 0                             │    │
│   │                                                                    │    │
│   │   if --strict-warnings:                                            │    │
│   │       fail = has_errors OR has_warnings                            │    │
│   │   else:                                                            │    │
│   │       fail = has_errors                                            │    │
│   │                                                                    │    │
│   └───────────────────────────────────────────────────────────────────┘    │
│           │                                                                 │
│     ┌─────┴─────┐                                                           │
│     ▼           ▼                                                           │
│ [pass]      [fail]                                                          │
│     │           │                                                           │
│     ▼           ▼                                                           │
│ EXIT(0)     EXIT(1)                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**CI 集成示例**:

```yaml
# .github/workflows/security.yml
- name: Security Audit
  run: calvin check --mode strict --strict-warnings
  # exit 1 if any error or warning
```

---

### 3.6 `calvin deploy --home`

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                               DEPLOY HOME COMMAND                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌───────────┐                                                             │
│   │   INIT    │                                                             │
│   └─────┬─────┘                                                             │
│         │                                                                   │
│         ▼                                                                   │
│   ┌───────────────┐                                                         │
│   │  PARSE_ASSETS │                                                         │
│   └───────┬───────┘                                                         │
│           │                                                                 │
│           ▼                                                                 │
│   ┌───────────────┐                                                         │
│   │   COMPILE     │                                                         │
│   └───────┬───────┘                                                         │
│           │                                                                 │
│           ▼                                                                 │
│   ┌───────────────┐                                                         │
│   │  SYNC_TO_HOME │  目标: ~/                                               │
│   │  (~/.claude/, │  • ~/.claude/commands/                                  │
│   │   ~/.codex/,  │  • ~/.codex/prompts/                                    │
│   │   ~/.gemini/) │  • ~/.gemini/antigravity/                               │
│   └───────┬───────┘                                                         │
│           │                                                                 │
│           ▼                                                                 │
│   ┌───────────────┐         ┌───────────────┐                              │
│   │ GENERATE_REPORT│────────▶│    EXIT(0)    │                              │
│   └───────────────┘         └───────────────┘                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 3.7 `calvin migrate`

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                               MIGRATE COMMAND                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌───────────┐                                                             │
│   │   INIT    │                                                             │
│   └─────┬─────┘                                                             │
│         │                                                                   │
│         ▼                                                                   │
│   ┌───────────────┐                                                         │
│   │ CHECK_VERSION │  当前版本 = 1.0                                         │
│   └───────┬───────┘                                                         │
│           │                                                                 │
│     ┌─────┴─────┐                                                           │
│     ▼           ▼                                                           │
│ [需要迁移]   [已是最新]                                                       │
│     │           │                                                           │
│     ▼           ▼                                                           │
│ MIGRATE      "No migration needed"                                          │
│     │           │                                                           │
│     ▼           ▼                                                           │
│ EXIT(0)     EXIT(0)                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**注**: 当前仅支持版本 1.0，迁移命令为未来保留。

---

### 3.8 `calvin parse`

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                PARSE COMMAND                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌───────────┐                                                             │
│   │   INIT    │                                                             │
│   └─────┬─────┘                                                             │
│         │                                                                   │
│         ▼                                                                   │
│   ┌───────────────┐    失败    ┌─────────────┐                             │
│   │  PARSE_DIR    │───────────▶│   ERROR     │──▶ exit(1)                  │
│   └───────┬───────┘            └─────────────┘                             │
│           │ ok                                                              │
│           ▼                                                                 │
│   ┌───────────────┐                                                         │
│   │ FORMAT_OUTPUT │  --json: NDJSON                                         │
│   │               │  default: 表格                                          │
│   └───────┬───────┘                                                         │
│           │                                                                 │
│           ▼                                                                 │
│   ┌───────────────┐                                                         │
│   │    EXIT(0)    │                                                         │
│   └───────────────┘                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 3.9 `calvin version`

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                               VERSION COMMAND                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌───────────┐                                                             │
│   │   INIT    │                                                             │
│   └─────┬─────┘                                                             │
│         │                                                                   │
│         ▼                                                                   │
│   ┌───────────────┐                                                         │
│   │ COLLECT_INFO  │                                                         │
│   │ • calvin ver  │                                                         │
│   │ • format ver  │                                                         │
│   │ • adapters    │                                                         │
│   └───────┬───────┘                                                         │
│           │                                                                 │
│           ▼                                                                 │
│   ┌───────────────┐                                                         │
│   │ FORMAT_OUTPUT │  --json: JSON object                                    │
│   │               │  default: 文本                                          │
│   └───────┬───────┘                                                         │
│           │                                                                 │
│           ▼                                                                 │
│   ┌───────────────┐                                                         │
│   │    EXIT(0)    │                                                         │
│   └───────────────┘                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 错误处理矩阵

### 4.1 输入验证错误

| 错误类型 | 触发条件 | 退出码 | 消息示例 |
|----------|----------|--------|----------|
| 路径不存在 | source 目录不存在 | 1 | `Error: .promptpack not found` |
| YAML 语法错误 | frontmatter 解析失败 | 1 | `Error parsing X: invalid YAML at line N` |
| 必填字段缺失 | 缺少 description | 1 | `Missing required field 'description'` |
| 无效安全模式 | --mode xxx | 降级 | 使用 "balanced" |
| 未知参数 | --unknown | 2 | clap 自动错误 |

### 4.2 运行时错误

| 错误类型 | 触发条件 | 退出码 | 恢复策略 |
|----------|----------|--------|----------|
| 文件锁定 | Windows 上文件被占用 | 1 | 重试 3 次 (100ms, 500ms, 1s) |
| 权限不足 | 无法写入目标 | 1 | 报告错误 |
| 远程连接失败 | SSH 无法连接 | 1 | 报告错误 |
| Home 目录未知 | $HOME 未设置 | 1 | 报告错误 |

### 4.3 配置降级行为

| 配置项 | 缺失时 | 无效时 |
|--------|--------|--------|
| config.toml | 使用默认值 | 报错并退出 |
| security.mode | "balanced" | "balanced" |
| targets.enabled | 全部启用 | 报错并退出 |
| format.version | "1.0" | 报错并退出 |

---

## 5. 全局选项与子命令选项

### 5.1 全局选项

| 选项 | 类型 | 默认值 | 作用 |
|------|------|--------|------|
| `--json` | bool | false | 输出 JSON 格式 |
| `-v, --verbose` | count | 0 | 增加日志详细度 |
| `-h, --help` | flag | - | 显示帮助 |
| `-V, --version` | flag | - | 显示版本 |

### 5.2 子命令选项表

| 命令 | `--source` | `--force` | `--interactive` | `--dry-run` | `--remote` | `--user` | `--mode` | `--strict-warnings` |
|------|:----------:|:---------:|:-------------:|:-----------:|:----------:|:--------:|:--------:|:-------------------:|
| sync | ✓ | ✓ | ✓ | ✓ | ✓ | - | - | - |
| watch | ✓ | - | - | - | - | - | - | - |
| diff | ✓ | - | - | - | - | - | - | - |
| doctor | - | - | - | - | - | - | ✓ | - |
| audit | - | - | - | - | - | - | ✓ | ✓ |
| install | ✓ | ✓ | - | ✓ | - | ✓* | - | - |
| migrate | - | - | - | ✓ | - | - | - | - |
| parse | ✓ | - | - | - | - | - | - | - |
| version | - | - | - | - | - | - | - | - |

*`--user` 当前必须提供

---

## 6. JSON 输出模式

当使用 `--json` 时，所有输出使用 NDJSON (Newline Delimited JSON) 格式：

```json
{"event":"sync","status":"success","written":5,"skipped":2,"errors":0}
{"event":"doctor","mode":"balanced","passes":8,"warnings":2,"errors":0,"success":true}
{"event":"audit","mode":"strict","passes":8,"warnings":0,"errors":2,"success":false}
```

这确保了：
- 每行是独立的 JSON 对象
- 可被 `jq` 等工具逐行处理
- 适合 CI/CD 日志解析

---

## 7. 信号处理

| 信号 | 命令 | 行为 |
|------|------|------|
| SIGINT (Ctrl+C) | watch | 优雅关闭，emit Shutdown event |
| SIGINT (Ctrl+C) | 其他 | 立即终止 |
| SIGTERM | 全部 | 立即终止 |

---

## 8. 并发与原子性保证

| 操作 | 保证 |
|------|------|
| 文件写入 | 原子 (tempfile + rename) |
| Lockfile 更新 | 原子 |
| 多文件同步 | 非原子 (逐个写入) |
| Watch 增量编译 | 单线程，顺序处理 |

---

## 9. 版本兼容性矩阵

| Calvin 版本 | 源格式版本 | 兼容的 IDE 输出 |
|-------------|------------|-----------------|
| 0.2.x | 1.0 | Claude Code 1.x, Cursor 0.44+, VS Code 1.96+, Antigravity, Codex |

---

*本规范覆盖 Calvin v0.2.0 的完整 CLI 行为*
