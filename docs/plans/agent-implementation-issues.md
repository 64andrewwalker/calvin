# Agent 实现问题分析

> Created: 2026-01-06
> Status: DRAFT

## 问题汇总

用户反馈了三个关键问题：

### 问题 1: Agent 部署到了错误的目录

**现象**：
```toml
# 实际输出 (lockfile)
[files."project:.agent/workflows/copywriter.md"]
source_asset = "copywriter"
source_file = ".promptpack/agents/copywriter.md"
```

**期望**：
```
.claude/agents/copywriter.md  # Claude Code 原生路径
```

**根本原因**：用户的 `config.toml` 中 `targets.enabled` 没有包含 `claude-code`，只包含了 `antigravity`。因此 `ClaudeCodeAdapter` 从未被调用，agents 被 `AntigravityAdapter` 处理后放到了 `.agent/workflows/`。

### 问题 2: Deploy 预览不显示 Agent 计数

**现象**：
```
Select layers to deploy:
> ○ user     ~/.calvin/.promptpack (36 assets, 0 skills)
  ● project  /path/to/.promptpack (37 assets, 20 skills)
```

没有显示 "X agents" 的计数。

**根本原因**：UI 层只统计 `assets` 和 `skills`，没有单独统计 `agents`。

### 问题 3: Claude Code Agent 输出格式错误

**现象** (当前 `compile_agent` 输出)：
```markdown
Description text

Content...

<!-- Generated by Calvin... -->
```

**期望** (根据官方文档)：
```markdown
---
name: your-sub-agent-name
description: Description of when this subagent should be invoked
tools: tool1, tool2, tool3
model: sonnet
---

Your subagent's system prompt goes here.

<!-- Generated by Calvin... -->
```

**根本原因**：`ClaudeCodeAdapter::compile_agent()` 没有生成 YAML frontmatter。

---

## 修复方案

### 修复 1: Claude Code Agent YAML Frontmatter

**文件**: `src/infrastructure/adapters/claude_code.rs`

**改动**:
```rust
fn compile_agent(&self, asset: &Asset) -> Result<Vec<OutputFile>, AdapterError> {
    let agents_dir = self.agents_dir(asset.scope());
    let agent_path = agents_dir.join(format!("{}.md", asset.id()));
    let footer = self.footer(&asset.source_path_normalized());

    // 生成 YAML frontmatter
    let mut frontmatter = String::from("---\n");
    frontmatter.push_str(&format!("name: {}\n", asset.id()));
    
    if !asset.description().trim().is_empty() {
        frontmatter.push_str(&format!("description: {}\n", asset.description()));
    }
    
    // TODO: 支持 tools, model, permissionMode, skills 字段
    // 这些需要扩展 Asset 或 Frontmatter 结构
    
    frontmatter.push_str("---\n");

    let content = format!(
        "{}\n{}\n\n{}",
        frontmatter,
        asset.content().trim(),
        footer
    );

    Ok(vec![OutputFile::new(agent_path, content, Target::ClaudeCode)])
}
```

### 修复 2: Asset/Frontmatter 扩展支持 Agent 特有字段

**文件**: `src/models.rs`, `src/domain/entities/asset.rs`

需要扩展 `Frontmatter` 支持：
- `tools: Vec<String>` - Agent 可用工具
- `model: Option<String>` - 使用的模型 (sonnet/opus/haiku/inherit)
- `permission_mode: Option<String>` - 权限模式
- `skills: Vec<String>` - 预加载的 skills

```yaml
# 示例 .promptpack/agents/reviewer.md
---
kind: agent
description: Code review specialist
scope: project
targets: [claude-code]
tools: [Read, Grep, Glob, Bash]
model: sonnet
---

You are a senior code reviewer...
```

### 修复 3: UI 显示 Agent 计数

**文件**: `src/ui/` 相关文件

在 layer 预览中添加 agent 计数：
```
> ○ user     ~/.calvin/.promptpack (36 assets, 2 agents, 0 skills)
  ● project  /path/to/.promptpack (35 assets, 2 agents, 20 skills)
```

### 修复 4: 文档更新

**文件**: `docs/api/frontmatter.md`, `docs/target-platforms.md`

记录：
1. Agent frontmatter 字段 (tools, model, permission_mode, skills)
2. Claude Code agent 输出格式
3. 各平台对 agent 的支持情况

---

## 平台 Agent 支持矩阵

| Platform | Agent Support | Output Path | Format |
|----------|--------------|-------------|--------|
| Claude Code | ✅ Native | `.claude/agents/<id>.md` | YAML frontmatter + body |
| Cursor | ⚠️ Fallback | `.cursor/commands/<id>.md` | Command fallback |
| VSCode | ⚠️ Fallback | `.github/instructions/<id>.instructions.md` + AGENTS.md | Instructions |
| Antigravity | ⚠️ Fallback | `.agent/workflows/<id>.md` | Workflow |
| Codex | ⚠️ Fallback | `.codex/prompts/<id>.md` | Prompt |

---

## 实现优先级

| Priority | Task | Effort |
|----------|------|--------|
| P0 | 修复 ClaudeCodeAdapter 输出 YAML frontmatter | Small |
| P1 | 扩展 Frontmatter 支持 tools/model 字段 | Medium |
| P2 | UI 显示 agent 计数 | Small |
| P3 | 文档更新 | Small |

---

## 测试计划

1. **单元测试**: `ClaudeCodeAdapter::compile_agent()` 生成正确的 YAML frontmatter
2. **集成测试**: 部署 agent 到 `.claude/agents/` 并验证文件格式
3. **契约测试**: 验证输出格式符合 Claude Code 官方规范

---

## 相关文件

- `src/infrastructure/adapters/claude_code.rs` - Claude Code adapter
- `src/infrastructure/adapters/antigravity.rs` - Antigravity adapter (当前被错误使用)
- `src/models.rs` - Frontmatter 定义
- `src/domain/entities/asset.rs` - Asset 实体
- `tests/cli_deploy_agents.rs` - Agent 部署测试
