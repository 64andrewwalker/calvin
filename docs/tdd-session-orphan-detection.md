# TDD Session: Scope Policy Consistency (SC-4/SC-5)

> **Date**: 2025-12-19  
> **Feature**: Orphan file detection in diff command  
> **Status**: Complete ✅

---

## Requirements Covered

1. **SC-4**: Add orphan file detection in `diff`
   - Load lockfile and compare against current outputs
   - Display orphan count in diff summary
   - Include orphans in JSON output

2. **SC-5**: Implement Calvin signature detection
   - Detect `<!-- Generated by Calvin -->` signature in files
   - Used to determine if orphan files are safe to delete

---

## TDD Cycles

### Cycle 1: Orphan Detection Module

**RED**: Created `src/sync/orphan.rs` with tests:
- `test_has_calvin_signature_html_comment`
- `test_has_calvin_signature_hash_comment`
- `test_has_calvin_signature_no_match`
- `test_detect_orphans_finds_removed_files`
- `test_detect_orphans_filters_by_namespace`
- `test_extract_path_from_key`
- `test_orphan_is_safe_to_delete`

**GREEN**: Implemented:
- `has_calvin_signature()` - detects Calvin markers in file content
- `detect_orphans()` - compares lockfile against current outputs
- `check_orphan_status()` - checks file existence and signature
- `OrphanFile` struct with `is_safe_to_delete()`

**REFACTOR**: Extracted `extract_path_from_key()` helper

### Cycle 2: Diff Summary with Orphans

**RED**: Added failing tests in `src/ui/views/diff.rs`:
- `summary_with_orphans_shows_orphan_count`
- `summary_with_zero_orphans_hides_orphan_line`

**GREEN**: Implemented:
- `render_diff_summary_with_orphans()` - new function with orphan count
- Updated `render_diff_summary()` to delegate to new function

**REFACTOR**: Preserved backward compatibility with wrapper function

### Cycle 3: cmd_diff Integration

**GREEN**: Updated `src/commands/debug.rs`:
- Added lockfile loading
- Added orphan detection call
- Updated JSON output to include `orphans` field
- Updated text output to use `render_diff_summary_with_orphans`

---

## Tests Written

| Test | File | Purpose |
|------|------|---------|
| `test_has_calvin_signature_html_comment` | orphan.rs | HTML comment signature |
| `test_has_calvin_signature_hash_comment` | orphan.rs | Hash comment signature |
| `test_has_calvin_signature_no_match` | orphan.rs | No false positives |
| `test_detect_orphans_finds_removed_files` | orphan.rs | Core orphan detection |
| `test_detect_orphans_filters_by_namespace` | orphan.rs | Namespace filtering |
| `test_extract_path_from_key` | orphan.rs | Key parsing |
| `test_orphan_is_safe_to_delete` | orphan.rs | Safety check logic |
| `summary_with_orphans_shows_orphan_count` | diff.rs | Orphan display |
| `summary_with_zero_orphans_hides_orphan_line` | diff.rs | Conditional display |

**Total new tests**: 9

---

## Implementation Decisions

1. **Orphan detection uses lockfile namespace**: Only checks entries matching current deployment target (home vs project)

2. **Orphan line hidden when count is zero**: Avoids clutter in common case

3. **Backward compatible API**: `render_diff_summary()` still works, delegates to new function

4. **Calvin signature patterns**: Three patterns detected:
   - `"Generated by Calvin"`
   - `"<!-- Generated by Calvin"`
   - `"# Auto-generated by Calvin"`

---

## Files Modified

| File | Changes |
|------|---------|
| `src/sync/orphan.rs` | **NEW** - Orphan detection module |
| `src/sync/mod.rs` | Added orphan module |
| `src/ui/views/diff.rs` | Added `render_diff_summary_with_orphans()` |
| `src/commands/debug.rs` | Integrated orphan detection in `cmd_diff` |

---

## Output Examples

### Text Output (with orphans)
```
╭────────────────╮
│ Δ Diff Summary │
│                │
│ 0 new          │
│ 0 modified     │
│ 147 unchanged  │
│ 3 orphan       │
╰────────────────╯
```

### JSON Output
```json
{"event":"complete","command":"diff","new":0,"modified":0,"unchanged":147,"orphans":0}
```

---

## Next Steps (SC-6, SC-7)

- [ ] **SC-6**: Add `--cleanup` flag to `deploy` to delete orphan files
- [ ] **SC-7**: Update lockfile to track deployment scope for cross-scope orphan detection
