# Implementation Plan

This document provides a phased roadmap for implementing Calvin. Each phase includes estimated complexity and success criteria.

---

## Phase 0: Project Bootstrap (Complexity: 2/10)

**Duration**: 1-2 days

### Tasks

- [ ] Initialize Rust project with `cargo init --name calvin`
- [ ] Set up workspace structure:
  ```
  calvin/
  ├── Cargo.toml
  ├── src/
  │   ├── main.rs        # CLI entry point
  │   ├── lib.rs         # Library exports
  │   ├── cli/           # CLI module
  │   ├── parser/        # Source parsing
  │   ├── compiler/      # Compilation engine
  │   ├── adapters/      # Platform adapters
  │   ├── sync/          # Sync engine
  │   └── security/      # Security module
  └── tests/             # Integration tests
  ```
- [ ] Add core dependencies to `Cargo.toml`:
  - `clap` - CLI with derive macros
  - `serde`, `serde_yaml`, `serde_json` - Parsing
  - `askama` or raw string substitution - Templates (NO Jinja)
  - `notify` - File watcher
  - `anyhow`, `thiserror` - Error handling
- [ ] Set up CI with GitHub Actions
- [ ] Configure cross-compilation targets

### Success Criteria
- `cargo build` succeeds
- `cargo test` runs (even with no tests)
- CI produces binaries for mac/win/linux

---

## Phase 1: Source Parser (Complexity: 4/10)

**Duration**: 3-5 days

### Tasks

- [ ] Define `PromptAsset` data structures:
  ```rust
  pub struct Frontmatter {
      pub id: String,
      pub title: String,
      pub kind: AssetKind,
      pub scope: Scope,
      pub targets: Vec<Target>,
      pub inputs: Option<Vec<InputDef>>,
      pub apply: Option<GlobPattern>,
  }
  
  pub enum AssetKind { Policy, Action, Agent }
  pub enum Scope { Project, User }
  pub enum Target { ClaudeCode, Cursor, VSCode, Antigravity, Codex, All }
  ```
- [ ] Implement frontmatter extraction
- [ ] Implement YAML frontmatter parsing with serde
- [ ] Add validation for required fields
- [ ] Parse `.promptpack/` directory structure
- [ ] Build asset dependency graph

### Success Criteria
- Parse sample `.promptpack/` directory
- Reject invalid files with clear error messages (file:line:column)
- All required fields validated

---

## Phase 2: Core Adapters - Project Scope (Complexity: 6/10)

**Duration**: 5-7 days

This phase implements **project-scope** output only (files that go in the repository).

### 2.1 Claude Code Adapter

- [ ] Generate `.claude/commands/<id>.md` from actions
- [ ] Generate `.claude/settings.json` with deny rules
- [ ] Insert `$ARGUMENTS` handling for inputs
- [ ] Add "Generated by" header

### 2.2 Cursor Adapter

- [ ] Generate `.cursor/rules/<id>/RULE.md` from policies
- [ ] Map frontmatter: `description`, `globs`, `alwaysApply`
- [ ] Generate `.cursor/commands/<id>.md` from actions

### 2.3 VS Code Adapter

- [ ] Generate `.github/copilot-instructions.md` from policies (merged)
- [ ] Generate `.github/instructions/<id>.md` with `applyTo` from policies (split mode)
- [ ] Generate root `AGENTS.md` as summary index

### 2.4 Antigravity Adapter

- [ ] Generate `.agent/rules/<id>.md` from policies
- [ ] Generate `.agent/workflows/<id>.md` from actions
- [ ] Map frontmatter to workflow format

### Success Criteria
- Full compile cycle: `.promptpack/` → all platform directories
- Generated files match platform specs
- Security deny lists auto-injected

---

## Phase 3: Sync Engine (Complexity: 5/10)

**Duration**: 3-5 days

### Tasks

- [ ] Implement `sync` command (one-shot)
  - Parse source
  - Compile to all targets
  - Write files (skip if unchanged - content hash)
- [ ] Implement `diff` command
  - Show what would change without writing
  - Color-coded output (green=add, red=remove, yellow=modify)
- [ ] Implement file header marker system
  - Add header to generated files
  - Detect unmarked files before overwrite
  - `--force` flag to override
- [ ] Implement idempotency checks
  - Same input = same output (deterministic hashing)

### Success Criteria
- `sync` is idempotent
- `diff` shows accurate preview
- Unmarked files protected

---

## Phase 4: File Watcher (Complexity: 4/10)

**Duration**: 2-3 days

### Tasks

- [ ] Implement `watch` command
  - Initialize notify watcher on `.promptpack/`
  - Debounce rapid changes (100ms)
  - Incremental compilation (only changed assets)
- [ ] Handle watcher errors gracefully
- [ ] Support Ctrl+C graceful shutdown
- [ ] NDJSON output for `--json` mode

### Success Criteria
- File changes trigger recompilation within 200ms
- No duplicate compilations for rapid edits
- Clean shutdown on interrupt

---

## Phase 5: Doctor & Validation (Complexity: 4/10)

**Duration**: 2-3 days

### Tasks

- [ ] Implement `doctor` command
  - Check each platform's output exists
  - Validate security baselines (deny lists, turbo mode, etc.)
  - Report missing configurations
- [ ] Security checks:
  - Claude Code: `permissions.deny` exists → ERROR if not
  - Antigravity: not in Turbo mode → WARNING if is
  - Cursor MCP: all servers in allowlist → BLOCK if not
- [ ] Output as checklist with pass/fail/warn

### Example Output:
```
$ calvin doctor

Claude Code
  ✓ .claude/settings.json exists
  ✓ permissions.deny configured
  ✓ 3 commands synced

Cursor
  ✓ .cursor/rules/ contains 2 rules
  ⚠ MCP server "unknown-server" not in allowlist

Antigravity
  ✓ .agent/rules/ contains 2 rules
  ✗ Terminal mode is "Turbo" (recommend "Auto")

VS Code
  ✓ .github/copilot-instructions.md exists
  ⚠ chat.useAgentsMdFile not enabled in settings
```

### Success Criteria
- All platform configurations validated
- Security violations surface as errors/warnings
- Actionable remediation suggestions

---

## Phase 6: User Scope & Remote Sync (Complexity: 5/10)

**Duration**: 3-5 days

### Tasks

- [ ] Implement `install --user` command
  - Write to user-level directories:
    - `~/.claude/commands/`
    - `~/.cursor/mcp.json`
    - `~/.gemini/` (Antigravity)
    - `~/.codex/prompts/`
- [ ] Implement Codex adapter
  - Generate prompts with `$ARGUMENTS` / `$KEY` substitution
  - Add usage documentation header
- [ ] Implement `sync --remote user@host:/path`
  - Use rsync over SSH
  - Support both project and user scope
  - Respect SSH config

### Success Criteria
- User-level installations work on all platforms
- Codex prompts functional with parameters
- Remote sync works with standard SSH auth

---

## Phase 7: Configuration & Polish (Complexity: 3/10)

**Duration**: 2-3 days

### Tasks

- [ ] Implement configuration hierarchy:
  1. CLI flags
  2. Environment variables (`CALVIN_*`)
  3. Project config (`.promptpack/config.toml`)
  4. User config (`~/.config/calvin/config.toml`)
  5. Defaults
- [ ] Support `--json` for all commands
- [ ] Implement `--verbose` / `--quiet` modes
- [ ] Shell completions (bash, zsh, fish, PowerShell)
- [ ] Man page generation

### Success Criteria
- Configuration cascades correctly
- All commands support JSON output
- Shell completions installable

---

## Phase 8: Testing & Documentation (Complexity: 4/10)

**Duration**: 3-5 days

### Tasks

- [ ] Unit tests for parser, adapters
- [ ] Snapshot tests for generated output
- [ ] Integration tests: full `.promptpack/` → outputs
- [ ] Golden test suite with reference inputs/outputs
- [ ] README with quick start guide
- [ ] Command reference documentation
- [ ] Example `.promptpack/` directory

### Success Criteria
- >80% test coverage
- All edge cases covered in snapshots
- Documentation sufficient for new users

---

## Phase 9: Distribution (Complexity: 3/10)

**Duration**: 1-2 days

### Tasks

- [ ] GitHub Actions release workflow
- [ ] Cross-compilation for all targets
- [ ] cargo-binstall manifest
- [ ] Homebrew formula
- [ ] Scoop manifest (Windows)
- [ ] Binary checksums

### Success Criteria
- One-liner installation on all platforms
- Releases automated on git tag

---

## Summary Timeline

| Phase | Complexity | Duration | Dependencies |
|-------|------------|----------|--------------|
| 0: Bootstrap | 2/10 | 1-2 days | None |
| 1: Parser | 4/10 | 3-5 days | Phase 0 |
| 2: Adapters | 6/10 | 5-7 days | Phase 1 |
| 3: Sync | 5/10 | 3-5 days | Phase 2 |
| 4: Watch | 4/10 | 2-3 days | Phase 3 |
| 5: Doctor | 4/10 | 2-3 days | Phase 2 |
| 6: User/Remote | 5/10 | 3-5 days | Phase 3 |
| 7: Config | 3/10 | 2-3 days | Phase 3 |
| 8: Testing | 4/10 | 3-5 days | All |
| 9: Distribution | 3/10 | 1-2 days | All |

**Total Estimated Duration**: 4-6 weeks

---

## Risk Mitigation

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Platform spec changes | Medium | High | Version pin platform adapters, monitor changelogs |
| Cross-compile issues | Medium | Medium | Use `cross` crate, CI for all targets |
| SSH auth complexity | Low | Medium | Shell out to system SSH, don't implement ourselves |
| Windows path handling | Medium | Medium | Use `Path` abstraction, test on Windows CI |
