#!/bin/bash
# Pre-commit hook for Calvin
# Ensures code quality before committing

set -e

echo "ðŸ” Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 1. Format check
echo -n "ðŸ“ Checking formatting... "
if cargo fmt --check > /dev/null 2>&1; then
    echo -e "${GREEN}âœ“${NC}"
else
    echo -e "${RED}âœ—${NC}"
    echo "Run 'cargo fmt' to fix formatting issues"
    exit 1
fi

# 2. Clippy (lints)
echo -n "ðŸ”Ž Running clippy... "
if cargo clippy --all-features --quiet -- -D warnings 2>/dev/null; then
    echo -e "${GREEN}âœ“${NC}"
else
    echo -e "${RED}âœ—${NC}"
    echo "Fix clippy warnings before committing"
    exit 1
fi

# 3. Tests with cargo-nextest (faster parallel execution)
# Falls back to cargo test if nextest is not installed
echo -n "ðŸ§ª Running tests... "
if command -v cargo-nextest &> /dev/null; then
    # Use nextest with pre-commit profile, skip slow CLI tests (~5s saved)
    # cli_deploy_targets: 25 tests that spawn processes
    if cargo nextest run --all-features --profile pre-commit \
        -E 'not binary(cli_deploy_targets)' 2>/dev/null; then
        echo -e "${GREEN}âœ“${NC}"
    else
        echo -e "${RED}âœ—${NC}"
        echo "Tests failed! Fix them before committing"
        exit 1
    fi
else
    # Fallback to cargo test
    echo -n "(nextest not found, using cargo test) "
    if cargo test --all-features --quiet --lib --bins --tests -- --skip contract_ 2>/dev/null; then
        echo -e "${GREEN}âœ“${NC}"
    else
        echo -e "${RED}âœ—${NC}"
        echo "Tests failed! Fix them before committing"
        exit 1
    fi
fi

# 5. Coverage check (optional, can be slow)
if [ "$CALVIN_CHECK_COVERAGE" = "1" ]; then
    echo -n "ðŸ“Š Checking coverage... "
    COVERAGE=$(cargo llvm-cov --all-features --summary-only 2>&1 | grep "TOTAL" | awk '{print $NF}' | sed 's/%//' || echo "0")
    if (( $(echo "$COVERAGE < 70" | bc -l) )); then
        echo -e "${RED}âœ—${NC} Coverage ${COVERAGE}% is below 70%"
        exit 1
    else
        echo -e "${GREEN}âœ“${NC} Coverage: ${COVERAGE}%"
    fi
else
    echo -e "${YELLOW}âš  Skipping coverage check (set CALVIN_CHECK_COVERAGE=1 to enable)${NC}"
fi

# 6. File size check (warning only, doesn't block commit)
if [ -x "./scripts/check-file-size.sh" ]; then
    echo ""
    if ! ./scripts/check-file-size.sh 2>/dev/null; then
        echo -e "${YELLOW}âš  Some files exceed recommended size limits${NC}"
        echo -e "${YELLOW}  Consider refactoring before the next major release${NC}"
    fi
fi

echo -e "\n${GREEN}âœ… All pre-commit checks passed!${NC}"
